<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CubeEngine v2.5.2 â€” í•™ìŠµ ëª¨ë‹ˆí„°</title>
<style>
:root {
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --green:#00ff88; --blue:#58a6ff; --yellow:#f5a623;
  --red:#ff6b6b; --purple:#a371f7; --text:#e6edf3; --sub:#8b949e;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Segoe UI',monospace;background:var(--bg);color:var(--text);padding:12px;min-height:100vh}

.hd{display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 18px;margin-bottom:12px}
.hd-title{font-size:17px;font-weight:bold;color:var(--green)}
.hd-meta{font-size:11px;color:var(--sub);text-align:right;line-height:1.8}
.badge{display:inline-block;background:#21262d;border:1px solid var(--border);color:var(--blue);font-size:10px;padding:2px 7px;border-radius:20px;margin-left:6px}

.btn-row{display:flex;gap:8px;margin-bottom:12px}
.btn{flex:1;padding:11px;border:none;border-radius:8px;font-size:13px;font-weight:bold;cursor:pointer;transition:all .15s}
.btn:active{transform:scale(.97)}
.btn-run{background:#238636;color:#fff}.btn-run:hover{background:#2ea043}
.btn-load{background:#21262d;color:var(--text);border:1px solid var(--border)}.btn-load:hover{background:#30363d}
.btn-reset{background:#6e1414;color:#fff}.btn-reset:hover{background:#b91c1c}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px}
@media(max-width:680px){.g2,.g4{grid-template-columns:1fr 1fr}}

.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
.card-ttl{font-size:11px;font-weight:bold;color:var(--sub);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.dot{width:8px;height:8px;border-radius:50%}
.dg{background:var(--green);box-shadow:0 0 6px var(--green)}
.db{background:var(--blue);box-shadow:0 0 5px var(--blue)}
.dy{background:var(--yellow)}.dr{background:var(--red)}.dp{background:var(--purple)}

.kv{font-size:26px;font-weight:bold;color:var(--green);line-height:1.1}
.ks{font-size:11px;color:var(--sub);margin-top:3px}
.kd{font-size:12px;margin-top:4px}
.up{color:var(--green)}.dn{color:var(--red)}.eq{color:var(--sub)}

.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:bold}
.c-idle{background:#21262d;color:var(--sub);border:1px solid var(--border)}
.c-run{background:#1a3a2a;color:var(--green);border:1px solid #2ea043;animation:blink .9s infinite}
.c-done{background:#1a2a3a;color:var(--blue);border:1px solid var(--blue)}
.c-err{background:#3a1a1a;color:var(--red);border:1px solid var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}

.pb-wrap{background:#21262d;border-radius:4px;height:7px;overflow:hidden;margin:8px 0}
.pb-fill{height:100%;border-radius:4px;transition:width .25s;background:var(--green)}

.timeline{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px}
.tl{width:13px;height:13px;border-radius:3px;background:#21262d;border:1px solid var(--border);transition:background .15s}
.tl.done{background:var(--green);border-color:var(--green)}
.tl.active{background:var(--yellow);border-color:var(--yellow);animation:blink .6s infinite}

.heatmap{display:grid;grid-template-columns:repeat(9,1fr);gap:3px;margin-top:6px}
.hm{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;cursor:pointer;transition:transform .12s}
.hm:hover{transform:scale(1.25);z-index:10;position:relative}

.bar-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.bar-n{width:22px;text-align:right;color:var(--blue);font-weight:bold}
.bar-bg{flex:1;background:#21262d;border-radius:3px;height:13px;overflow:hidden}
.bar-f{height:100%;border-radius:3px;background:var(--purple);transition:width .35s}
.bar-p{width:40px;text-align:right;color:var(--sub)}

canvas{width:100%;border-radius:8px;display:block;background:#010409;border:1px solid var(--border)}

.cl{max-height:140px;overflow-y:auto;font-size:11px;margin-top:6px}
.cl-row{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #1c2128}
.cl-n{color:var(--blue);font-weight:bold;width:26px}
.cl-up{color:var(--green)}.cl-dn{color:var(--red)}

.term{background:#010409;border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-family:monospace;font-size:11px;color:var(--green);height:160px;overflow-y:auto;line-height:1.7;margin-top:6px}
.ti{color:var(--blue)}.tw{color:var(--yellow)}.ts{color:var(--green)}.te{color:var(--red)}

.combo-wrap{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.combo-row{display:flex;align-items:center;gap:4px}
.cr{font-size:10px;color:var(--sub);width:20px}
.ball{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold}
.b1{background:linear-gradient(135deg,#FFD700,#FFA500);color:#222}
.b2{background:linear-gradient(135deg,#4dabf7,#1971c2);color:#fff}
.b3{background:linear-gradient(135deg,#ff6b6b,#c92a2a);color:#fff}
.b4{background:linear-gradient(135deg,#495057,#212529);color:#fff}
.b5{background:linear-gradient(135deg,#51cf66,#2f9e44);color:#fff}
.cs{font-size:10px;color:var(--purple);margin-left:4px}

/* poolSize ìŠ¬ë¼ì´ë” */
.pool-ctrl{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.pool-label{font-size:12px;color:var(--sub);white-space:nowrap;flex-shrink:0}
.pool-slider{flex:1;min-width:160px;-webkit-appearance:none;height:5px;border-radius:3px;background:linear-gradient(to right,var(--green) 0%,var(--green) var(--pct,10%),#21262d var(--pct,10%));outline:none;cursor:pointer}
.pool-slider:disabled{opacity:0.5;cursor:not-allowed}
.pool-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--green);border:2px solid #0d1117;box-shadow:0 0 5px var(--green);cursor:pointer}
.pool-slider:disabled::-webkit-slider-thumb{cursor:not-allowed;opacity:0.5}
.pool-slider::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--green);border:2px solid #0d1117;cursor:pointer}
.pool-slider:disabled::-moz-range-thumb{cursor:not-allowed;opacity:0.5}
.pool-val{font-size:16px;font-weight:bold;color:var(--green);min-width:54px;text-align:right}
.pool-marks{display:flex;justify-content:space-between;font-size:9px;color:var(--sub);margin-top:2px;flex:1;min-width:160px;padding:0 8px}

/* í•™ìŠµ ê²½ë¡œ í‘œì‹œ */
.path-box{background:#0d1117;border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:11px;font-family:monospace;margin-bottom:10px}
.path-row{display:flex;align-items:center;gap:10px;padding:3px 0}
.path-label{color:var(--sub);width:100px;flex-shrink:0}
.path-val{color:var(--yellow);font-weight:bold}
.path-match{color:var(--green);font-size:10px;margin-left:6px}
.path-mismatch{color:var(--red);font-size:10px;margin-left:6px}

.sg{display:grid;grid-template-columns:repeat(5,1fr);gap:3px;margin-top:6px}
.sg-c{background:#21262d;border-radius:4px;padding:4px 2px;text-align:center;font-size:9px}
.sg-n{color:var(--blue);font-weight:bold}.sg-v{color:var(--green);margin-top:1px}
</style>
</head>
<body>

<!-- í—¤ë” -->
<div class="hd">
  <div>
    <span class="hd-title">ğŸ§Š CubeEngine í•™ìŠµ ëª¨ë‹ˆí„°</span>
    <a href="setCubeEngine.html" style="background:#21262d;color:#58a6ff;border:1px solid #30363d;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:bold;text-decoration:none;">âš™ï¸ ì—”ì§„ ì„¤ì •</a>
    <span class="badge" id="verBadge">v2.1.0</span>
  </div>
  <div class="hd-meta">
    <div>ìƒíƒœ: <span id="chipWrap"><span class="chip c-idle">â¬œ ëŒ€ê¸° ì¤‘</span></span></div>
    <div>ëˆ„ì  í•™ìŠµ: <strong id="iterCount" style="color:var(--green)">0</strong>íšŒ &nbsp;|&nbsp; ì¶œì²˜: <span id="lastSource">-</span> &nbsp;|&nbsp; ë§ˆì§€ë§‰: <span id="lastRun">-</span></div>
  </div>
</div>

<!-- í•™ìŠµ ê²½ë¡œ ë™ê¸°í™” ìƒíƒœ -->
<div class="path-box">
  <div class="path-row">
    <span class="path-label">ğŸ“ ì»¬ë ‰ì…˜</span>
    <span class="path-val">lotto_history</span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ“„ ë¬¸ì„œ</span>
    <span class="path-val">shared_engine_state</span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ”‘ probMap í‚¤</span>
    <span class="path-val">n1, n2, ... n45</span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼ í¬ë§·</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ”€ ë³‘í•© ë°©ì‹</span>
    <span class="path-val">íŠ¸ëœì­ì…˜ ê°€ì¤‘í‰ê·  ëˆ„ì </span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼ ë¡œì§</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ—‚ ë‹¹ì²¨ íˆìŠ¤í† ë¦¬</span>
    <span class="path-val">lotto_history / lotto645_history â†’ draws</span>
    <span id="historyStatus" class="path-match">â³ ë¡œë”© ëŒ€ê¸°</span>
  </div>
</div>

<!-- poolSize ìŠ¬ë¼ì´ë” -->
<div class="pool-ctrl">
  <span class="pool-label">ğŸ› Pool Size</span>
  <div style="flex:1;min-width:160px">
    <input type="range" class="pool-slider" id="poolSlider"
      min="100" max="10000" step="100" value="2500"
      oninput="updatePoolSlider(this.value)">
    <div class="pool-marks">
      <span>100</span><span>2,500</span><span>5,000</span><span>7,500</span><span>10,000</span>
    </div>
  </div>
  <span class="pool-val" id="poolValDisp">2,500</span>
</div>

<!-- ë²„íŠ¼ -->
<div class="btn-row">
  <button class="btn btn-run"   id="btnRun">â–¶ í•™ìŠµ ì‹¤í–‰ (ë¡œë˜ ì›¹ê³¼ ê³µìœ )</button>
  <button class="btn" id="btnBacktest" style="background:#1f4068;color:#58a6ff;border:1px solid #58a6ff;">ğŸ”¬ ë°±í…ŒìŠ¤íŒ… ì‹¤í–‰</button>
  <button class="btn" id="btnApplyBt" style="background:#1a3a1a;color:#00ff88;border:1px solid #00ff88;display:none;">âœ… ë¡œë˜ ì›¹ì— ì ìš©</button>
</div>

<!-- ë°±í…ŒìŠ¤íŒ… íŒ¨ë„ -->
<div id="btPanel" style="display:none;margin-bottom:12px;">
  <div class="card" style="border-color:#1f4068;">
    <div class="card-ttl"><div class="dot db"></div>ë°±í…ŒìŠ¤íŒ… â€” ì‹¤ì œ ë‹¹ì²¨ ê²€ì¦ í•™ìŠµ (ë§¤ íšŒì°¨ë§ˆë‹¤ ìë™ ì €ì¥ â†’ ì–¸ì œë“ ì§€ ì¤‘ë‹¨ í›„ ì¬ê°œ ê°€ëŠ¥ | ì™„ë£Œ í›„ "âœ… ë¡œë˜ ì›¹ì— ì ìš©" ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ë°˜ì˜)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:12px;">
      <div style="background:#0d1117;border-radius:8px;padding:10px;text-align:center;">
        <div style="font-size:20px;font-weight:bold;color:#58a6ff;" id="btCurDraw">-</div>
        <div style="font-size:10px;color:var(--sub)">í˜„ì¬ íšŒì°¨</div>
      </div>
      <div style="background:#0d1117;border-radius:8px;padding:10px;text-align:center;">
        <div style="font-size:20px;font-weight:bold;color:#00ff88;" id="btHitRate">-</div>
        <div style="font-size:10px;color:var(--sub)">í‰ê·  ì ì¤‘ ë²ˆí˜¸ìˆ˜</div>
      </div>
      <div style="background:#0d1117;border-radius:8px;padding:10px;text-align:center;">
        <div style="font-size:20px;font-weight:bold;color:#f5a623;" id="btProgress">0%</div>
        <div style="font-size:10px;color:var(--sub)">ì§„í–‰ë¥ </div>
      </div>
      <div style="background:#0d1117;border-radius:8px;padding:10px;text-align:center;">
        <div style="font-size:20px;font-weight:bold;color:#a371f7;" id="btBestHit">-</div>
        <div style="font-size:10px;color:var(--sub)">ìµœê³  ì ì¤‘ ìˆ˜</div>
      </div>
    </div>
    <!-- ì§„í–‰ë°” -->
    <div style="background:#21262d;border-radius:4px;height:8px;margin-bottom:8px;overflow:hidden;">
      <div id="btBar" style="height:100%;background:linear-gradient(90deg,#58a6ff,#00ff88);width:0%;transition:width .3s;border-radius:4px;"></div>
    </div>
    <!-- ë“±ìˆ˜ í†µê³„ -->
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
      <div style="background:#1a1a2e;border-radius:6px;padding:6px 10px;text-align:center;flex:1;">
        <div style="font-size:16px;font-weight:bold;color:#ff6b6b;" id="bt6">0</div>
        <div style="font-size:10px;color:var(--sub)">6ê°œ ì¼ì¹˜ (1ë“±)</div>
      </div>
      <div style="background:#1a1a2e;border-radius:6px;padding:6px 10px;text-align:center;flex:1;">
        <div style="font-size:16px;font-weight:bold;color:#f5a623;" id="bt5">0</div>
        <div style="font-size:10px;color:var(--sub)">5ê°œ ì¼ì¹˜ (2~3ë“±)</div>
      </div>
      <div style="background:#1a1a2e;border-radius:6px;padding:6px 10px;text-align:center;flex:1;">
        <div style="font-size:16px;font-weight:bold;color:#58a6ff;" id="bt4">0</div>
        <div style="font-size:10px;color:var(--sub)">4ê°œ ì¼ì¹˜ (4ë“±)</div>
      </div>
      <div style="background:#1a1a2e;border-radius:6px;padding:6px 10px;text-align:center;flex:1;">
        <div style="font-size:16px;font-weight:bold;color:#00ff88;" id="bt3">0</div>
        <div style="font-size:10px;color:var(--sub)">3ê°œ ì¼ì¹˜ (5ë“±)</div>
      </div>
      <div style="background:#1a1a2e;border-radius:6px;padding:6px 10px;text-align:center;flex:1;">
        <div style="font-size:16px;font-weight:bold;color:var(--sub);" id="bt2">0</div>
        <div style="font-size:10px;color:var(--sub)">2ê°œ ì´í•˜</div>
      </div>
    </div>
    <!-- í˜„ì¬ íšŒì°¨ ë³¼ í‘œì‹œ -->
    <div style="margin-bottom:8px;">
      <div style="font-size:10px;color:var(--sub);margin-bottom:4px;">ğŸ¯ ì˜ˆì¸¡ ì¡°í•©</div>
      <div id="btPredBalls" style="display:flex;gap:4px;flex-wrap:wrap;min-height:32px;"></div>
      <div style="font-size:10px;color:var(--sub);margin:4px 0;">âœ… ì‹¤ì œ ë‹¹ì²¨</div>
      <div id="btActualBalls" style="display:flex;gap:4px;flex-wrap:wrap;min-height:32px;"></div>
    </div>
    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="btStatus" style="font-size:12px;color:var(--sub);padding:6px 0;">ëŒ€ê¸° ì¤‘...</div>
    <!-- 50íšŒ ì²´í¬í¬ì¸íŠ¸ ì»¨íŠ¸ë¡¤ -->
    <div style="background:#0d1117;border-radius:6px;padding:10px;margin-top:8px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <span style="font-size:11px;color:var(--sub);">ì²´í¬í¬ì¸íŠ¸:</span>
        <span id="btCheckpoint" style="font-size:12px;font-weight:bold;color:#58a6ff;">-</span>
        <span style="font-size:11px;color:var(--sub);">| ì „ì²´ ë°˜ë³µ:</span>
        <strong id="btRepeatCount" style="color:#a371f7;">0</strong>íšŒ
        <span style="font-size:11px;color:var(--sub);">| ëˆ„ì  í•™ìŠµ:</span>
        <strong id="btTotalDraws" style="color:#00ff88;">0</strong>íšŒì°¨
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button id="btnBtContinue" style="display:none;background:#1f4068;color:#58a6ff;border:1px solid #58a6ff;border-radius:6px;padding:6px 12px;font-size:11px;font-weight:bold;cursor:pointer;">â–¶ ì¤‘ë‹¨ëœ ì§€ì ë¶€í„° ê³„ì†</button>
        <button id="btnBtRestart" style="display:none;background:#2d1a00;color:#f5a623;border:1px solid #f5a623;border-radius:6px;padding:6px 12px;font-size:11px;font-weight:bold;cursor:pointer;">â†º ì²˜ìŒë¶€í„° ì¬ì‹œì‘</button>
        <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;">
          <input type="checkbox" id="btRepeat" style="width:14px;height:14px;">
          <span style="color:#8b949e;">ì „ì²´ ì™„ë£Œ ì‹œ ìë™ ë°˜ë³µ</span>
        </label>
        <span style="font-size:10px;color:#69c8f0;margin-left:10px;">ğŸ’¾ ë§¤ íšŒì°¨ë§ˆë‹¤ ìë™ ì €ì¥ â†’ ì–¸ì œë“ ì§€ ë¸Œë¼ìš°ì € ì¢…ë£Œ í›„ ì¬ì§„ì… ì‹œ ìë™ ì´ì–´ì„œ ì§„í–‰</span>
      </div>
    </div>
    <!-- ìµœê·¼ ê²°ê³¼ ë¡œê·¸ -->
    <div id="btLog" style="max-height:120px;overflow-y:auto;font-size:11px;font-family:monospace;background:#0d1117;border-radius:6px;padding:8px;margin-top:8px;"></div>
  </div>
</div>

<!-- KPI í•œì¤„ ë°” -->
<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;display:grid;grid-template-columns:repeat(4,1fr);margin-bottom:10px;">
  <div style="padding:14px 10px;text-align:center;border-right:1px solid var(--border);">
    <div style="font-size:11px;font-weight:bold;color:var(--sub);letter-spacing:.06em;display:flex;align-items:center;justify-content:center;gap:5px;margin-bottom:6px;"><div class="dot dg"></div>ëˆ„ì  ITERATION</div>
    <div style="font-size:32px;font-weight:bold;color:var(--green);line-height:1;" id="kpiIter">0</div>
    <div style="font-size:10px;color:var(--sub);margin-top:5px;">ì´ í•™ìŠµ íšŸìˆ˜</div>
  </div>
  <div style="padding:14px 10px;text-align:center;border-right:1px solid var(--border);">
    <div style="font-size:11px;font-weight:bold;color:var(--sub);letter-spacing:.06em;display:flex;align-items:center;justify-content:center;gap:5px;margin-bottom:6px;"><div class="dot db"></div>POOL í¬ê¸°</div>
    <div style="font-size:32px;font-weight:bold;color:var(--blue);line-height:1;" id="kpiPool">0</div>
    <div style="font-size:10px;color:var(--sub);margin-top:5px;">ìƒì¡´ ì¡°í•© ìˆ˜</div>
  </div>
  <div style="padding:14px 10px;text-align:center;border-right:1px solid var(--border);">
    <div style="font-size:11px;font-weight:bold;color:var(--sub);letter-spacing:.06em;display:flex;align-items:center;justify-content:center;gap:5px;margin-bottom:6px;"><div class="dot dy"></div>BEST SCORE</div>
    <div style="font-size:32px;font-weight:bold;color:var(--yellow);line-height:1;" id="kpiBest">-</div>
    <div id="kpiBestDiff" style="font-size:11px;margin-top:5px;min-height:16px;"></div>
  </div>
  <div style="padding:14px 10px;text-align:center;">
    <div style="font-size:11px;font-weight:bold;color:var(--sub);letter-spacing:.06em;display:flex;align-items:center;justify-content:center;gap:5px;margin-bottom:6px;"><div class="dot dp"></div>ë³€í™” ë²ˆí˜¸</div>
    <div style="font-size:32px;font-weight:bold;color:var(--purple);line-height:1;" id="kpiChanged">0</div>
    <div style="font-size:10px;color:var(--sub);margin-top:5px;">í™•ë¥  ë³€ë™ ìˆ˜</div>
  </div>
</div>

<!-- ì§„í–‰ + íƒ€ì„ë¼ì¸ -->
<div class="g2">
  <div class="card">
    <div class="card-ttl"><div class="dot dg"></div>ì§„í–‰ ìƒí™©</div>
    <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
      <span id="phaseText" style="color:var(--yellow)">ëŒ€ê¸° ì¤‘</span>
      <span id="pctText"   style="color:var(--green);font-weight:bold">0%</span>
    </div>
    <div class="pb-wrap"><div class="pb-fill" id="mainBar" style="width:0%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--sub);margin-top:4px">
      <span>ê²½ê³¼: <span id="elapsed">0s</span></span>
      <span>ë¼ìš´ë“œ: <span id="roundNow">0</span>/<span id="roundTotal">50</span></span>
      <span>pool: <span id="poolNow">0</span></span>
    </div>
  </div>
  <div class="card">
    <div class="card-ttl"><div class="dot db"></div>ë¼ìš´ë“œ íƒ€ì„ë¼ì¸</div>
    <div class="timeline" id="timeline"></div>
  </div>
</div>

<!-- íˆíŠ¸ë§µ + ë°” ì°¨íŠ¸ -->
<div class="g2">
  <div class="card">
    <div class="card-ttl"><div class="dot dp"></div>í™•ë¥ ë§µ íˆíŠ¸ë§µ (1~45)</div>
    <div class="heatmap" id="heatmap"></div>
  </div>
  <div class="card">
    <div class="card-ttl"><div class="dot dy"></div>ìƒìœ„ 10ë²ˆí˜¸ í™•ë¥ </div>
    <div id="barChart" style="margin-top:6px"></div>
  </div>
</div>

<!-- í•™ìŠµ ê³¡ì„  + ë³€í™” ë¡œê·¸ -->
<div class="g2">
  <div class="card">
    <div class="card-ttl"><div class="dot dg"></div>í•™ìŠµ ê³¡ì„  (Best Score)</div>
    <canvas id="curveCanvas" height="110"></canvas>
  </div>
  <div class="card">
    <div class="card-ttl"><div class="dot db"></div>í™•ë¥  ë³€í™” ë¡œê·¸ (ì´ì „ ëŒ€ë¹„)</div>
    <div class="cl" id="changeLog"><span style="color:var(--sub)">ëŒ€ê¸° ì¤‘...</span></div>
  </div>
</div>

<!-- StatCache ë¶„ì„ -->
<div class="card" style="margin-bottom:10px">
  <div class="card-ttl"><div class="dot dy"></div>StatCache â€” ë¹ˆë„ / ìµœê·¼30íšŒ / ê°„ê²© / ì¬ì¶œí˜„ (Top 10)</div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:6px">
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ğŸ”¥ Top ë¹ˆë„</div><div class="sg" id="statFreq"></div></div>
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">âš¡ ìµœê·¼30íšŒ</div><div class="sg" id="statRecent"></div></div>
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">â± ê°„ê²©(ë¯¸ì¶œí˜„)</div><div class="sg" id="statGap"></div></div>
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ğŸ”„ ì¬ì¶œí˜„ë¥ </div><div class="sg" id="statReHit"></div></div>
  </div>
</div>

<!-- ì‹¤ì‹œê°„ ë¡œê·¸ (ì „ì²´ ë„ˆë¹„) -->
<div class="card" style="margin-bottom:10px;">
  <div class="card-ttl"><div class="dot db"></div>ì‹¤ì‹œê°„ ë¡œê·¸</div>
  <div class="term" id="terminal" style="height:200px;"><span class="ti">[ì‹œìŠ¤í…œ] CubeEngine v2.2.1 ì¤€ë¹„ ì™„ë£Œ</span></div>
</div>

<!-- ì¶”ì²œ ì¡°í•© (ì „ì²´ ë„ˆë¹„) -->
<div class="card" style="margin-bottom:10px;">
  <div class="card-ttl"><div class="dot dg"></div>ì¶”ì²œ ì¡°í•© Top 5</div>
  <div class="combo-wrap" id="comboWrap"><span style="color:var(--sub);font-size:12px">í•™ìŠµ ì™„ë£Œ í›„ í‘œì‹œë©ë‹ˆë‹¤</span></div>
</div>

<script src="cube-engine.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase ì´ˆê¸°í™”
//  â˜… ë¡œë˜ ì›¹ê³¼ ì™„ì „íˆ ë™ì¼í•œ ì»¬ë ‰ì…˜/ë¬¸ì„œ ì‚¬ìš©
//    ì»¬ë ‰ì…˜: lotto_history
//    ë¬¸ì„œ  : shared_engine_state
//    í‚¤    : n1~n45 (ì ‘ë‘ì‚¬ 'n')
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
  apiKey:"AIzaSyB4S8qkK07QYXq5yw0Coo69sZBIk0uew2E",
  authDomain:"randextraccube-engine.firebaseapp.com",
  projectId:"randextraccube-engine",
  storageBucket:"randextraccube-engine.firebasestorage.app",
  messagingSenderId:"515597545439",
  appId:"1:515597545439:web:f1e804554406719a3cde6a"
});
var db = firebase.firestore();

// â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ ê²½ë¡œ
var SHARED_COL = 'lotto_history';
var SHARED_DOC  = 'shared_engine_state';
var BACKTEST_DOC = 'backtest_engine_state';  // ë°±í…ŒìŠ¤íŒ… ì „ìš© ê²½ë¡œ
var BACKTEST_PROGRESS_DOC = 'backtest_progress';  // ë°±í…ŒìŠ¤íŒ… ì§„í–‰ë„ ì €ì¥ (v2.5.2)
var DOC = db.collection(SHARED_COL).doc(SHARED_DOC);
var BT_DOC = db.collection(SHARED_COL).doc(BACKTEST_DOC);
var BT_PROGRESS_DOC = db.collection(SHARED_COL).doc(BACKTEST_PROGRESS_DOC);

// â•â• ìƒíƒœ â•â•
var S = { iter:0, prevMap:null, curMap:null, curve:[], prevBest:0, running:false, source:'-', historyNums:[] };
var $ = function(id){ return document.getElementById(id); };

// â•â• í„°ë¯¸ë„ â•â•
function tlog(msg, cls) {
  var t=$('terminal');
  var d=document.createElement('div'); d.className=cls||'';
  d.textContent='['+new Date().toLocaleTimeString('ko-KR')+'] '+msg;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

// â•â• poolSize ìŠ¬ë¼ì´ë” â•â•
function updatePoolSlider(val){
  val = Math.round(val / 100) * 100;
  var pct = ((val - 100) / (10000 - 100) * 100).toFixed(1) + '%';
  var slider = $('poolSlider');
  slider.style.setProperty('--pct', pct);
  $('poolValDisp').textContent = Number(val).toLocaleString();
}
// ì´ˆê¸° ìŠ¬ë¼ì´ë” ìƒíƒœ ì„¤ì •
(function(){ updatePoolSlider(2500); })();

// â•â• ë¡œë˜ ì›¹ ë‹¹ì²¨ history ë¡œë“œ â•â•
//    ê²½ë¡œ: lotto_history / lotto645_history â†’ draws[].numbers
async function loadLottoHistory(){
  var statusEl = $('historyStatus');
  statusEl.className = 'path-match';
  statusEl.textContent = 'ğŸ”„ ë¡œë”© ì¤‘...';
  try {
    var snap = await db.collection('lotto_history').doc('lotto645_history').get();
    if(!snap.exists){
      statusEl.className = 'path-mismatch';
      statusEl.textContent = 'âš ï¸ ë¬¸ì„œ ì—†ìŒ';
      tlog('ë‹¹ì²¨ íˆìŠ¤í† ë¦¬: ë¬¸ì„œ ì—†ìŒ (lotto645_history)','tw');
      return [];
    }
    var data = snap.data();
    if(!data.draws || !data.draws.length){
      statusEl.className = 'path-mismatch';
      statusEl.textContent = 'âš ï¸ draws ë¹„ì–´ìˆìŒ';
      tlog('ë‹¹ì²¨ íˆìŠ¤í† ë¦¬: draws í•„ë“œ ì—†ìŒ ë˜ëŠ” ë¹ˆê°’','tw');
      return [];
    }
    var draws = data.draws.filter(function(d){ return d.numbers&&d.numbers.length===6; });
    var nums  = draws.map(function(d){ return d.numbers; });
    var bonus = draws.map(function(d){ return d.bonus; }).filter(function(b){ return b&&b>=1&&b<=45; });
    statusEl.className = 'path-match';
    statusEl.textContent = 'âœ… '+nums.length+'íšŒì°¨ ë¡œë“œ ì™„ë£Œ (ë³´ë„ˆìŠ¤: '+bonus.length+'ê°œ)';
    tlog('âœ… ë‹¹ì²¨ íˆìŠ¤í† ë¦¬ ë¡œë“œ: '+nums.length+'íšŒì°¨ | ë³´ë„ˆìŠ¤: '+bonus.length+'ê°œ','ts');
    return { nums: nums, bonus: bonus, draws: draws };
  } catch(e){
    statusEl.className = 'path-mismatch';
    statusEl.textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨';
    tlog('ë‹¹ì²¨ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨: '+e.message,'te');
    return [];
  }
}

// â•â• ìƒíƒœ ì¹© â•â•
function setChip(type){
  var m={idle:'<span class="chip c-idle">â¬œ ëŒ€ê¸° ì¤‘</span>',
         run :'<span class="chip c-run">ğŸŸ¢ ì‹¤í–‰ ì¤‘</span>',
         done:'<span class="chip c-done">ğŸ”µ ì™„ë£Œ</span>',
         err :'<span class="chip c-err">ğŸ”´ ì˜¤ë¥˜</span>'};
  $('chipWrap').innerHTML=m[type]||m.idle;
}

// â•â• íƒ€ì„ë¼ì¸ â•â•
function initTL(n){
  var tl=$('timeline'); tl.innerHTML=''; $('roundTotal').textContent=n;
  for(var i=0;i<n;i++){var d=document.createElement('div');d.className='tl';d.id='tl'+i;tl.appendChild(d);}
}
function tickTL(r){
  var p=document.getElementById('tl'+(r-1)); if(p) p.className='tl done';
  var c=document.getElementById('tl'+r);    if(c) c.className='tl active';
}

// â•â• íˆíŠ¸ë§µ â•â•
function renderHM(probMap){
  if(!probMap) return;
  var hm=$('heatmap'); hm.innerHTML='';
  var vals=[]; for(var i=1;i<=45;i++) vals.push(probMap[i]||0);
  var mx=Math.max.apply(null,vals)||1, mn=Math.min.apply(null,vals);
  for(var i=1;i<=45;i++){
    var v=probMap[i]||0, t=(v-mn)/(mx-mn||1);
    var r=Math.round(t*80), g=Math.round(100+t*155), b=Math.round(50+t*50);
    var c=document.createElement('div'); c.className='hm';
    c.style.background='rgb('+r+','+g+','+b+')';
    c.style.color=t>0.55?'#000':'#fff';
    c.title='No.'+i+': '+(v*100).toFixed(2)+'%';
    c.textContent=i; hm.appendChild(c);
  }
}

// â•â• ë°” ì°¨íŠ¸ â•â•
function renderBar(probMap){
  if(!probMap) return;
  var arr=[]; for(var i=1;i<=45;i++) arr.push({n:i,v:probMap[i]||0});
  arr.sort(function(a,b){return b.v-a.v;}); var top=arr.slice(0,10);
  var mx=top[0].v||1, html='';
  top.forEach(function(x){
    var pct=(x.v/mx*100).toFixed(0);
    html+='<div class="bar-row"><div class="bar-n">'+x.n+'</div>'+
      '<div class="bar-bg"><div class="bar-f" style="width:'+pct+'%"></div></div>'+
      '<div class="bar-p">'+(x.v*100).toFixed(2)+'%</div></div>';
  });
  $('barChart').innerHTML=html;
}

// â•â• ë³€í™” ë¡œê·¸ â•â•
function renderCL(oldMap, newMap){
  if(!newMap) return;
  var html='', changed=0;
  for(var i=1;i<=45;i++){
    var o=oldMap?(oldMap[i]||0):0, n=newMap[i]||0, d=n-o;
    if(Math.abs(d)<0.0001) continue; changed++;
    var up=d>0;
    html+='<div class="cl-row"><span class="cl-n">'+i+'</span>'+
      '<span style="color:var(--sub)">'+o.toFixed(4)+' â†’ </span>'+
      '<span class="'+(up?'cl-up':'cl-dn')+'">'+n.toFixed(4)+' '+(up?'â–²':'â–¼')+Math.abs(d).toFixed(4)+'</span></div>';
  }
  $('changeLog').innerHTML=html||'<span style="color:var(--sub)">ë³€í™” ì—†ìŒ</span>';
  $('kpiChanged').textContent=changed;
}

// â•â• í•™ìŠµ ê³¡ì„  â•â•
function renderCurve(){
  var cv=$('curveCanvas'), W=cv.offsetWidth||380, H=110;
  cv.width=W; cv.height=H;
  var ctx=cv.getContext('2d'); ctx.clearRect(0,0,W,H);
  var data=S.curve;
  if(data.length<2){ctx.fillStyle='#8b949e';ctx.font='11px monospace';ctx.fillText('ë°ì´í„° ë¶€ì¡±',10,H/2);return;}
  var mx=Math.max.apply(null,data), mn=Math.min.apply(null,data)*0.98;
  ctx.strokeStyle='#21262d'; ctx.lineWidth=1;
  for(var i=0;i<=4;i++){var y=H-(i/4)*H;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  ctx.beginPath(); ctx.strokeStyle='#00ff88'; ctx.lineWidth=2;
  data.forEach(function(v,i){
    var x=i/(data.length-1)*W, y=H-((v-mn)/(mx-mn||1))*(H-6)-3;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  var lv=data[data.length-1], lx=W, ly=H-((lv-mn)/(mx-mn||1))*(H-6)-3;
  ctx.beginPath(); ctx.arc(lx-1,ly,4,0,Math.PI*2); ctx.fillStyle='#00ff88'; ctx.fill();
  ctx.fillStyle='#8b949e'; ctx.font='9px monospace'; ctx.textAlign='left';
  ctx.fillText(mx.toFixed(1),2,10); ctx.fillText(mn.toFixed(1),2,H-4);
}

// â•â• StatCache ë Œë” â•â•
function renderStat(history){
  if(!history||!history.length||!CubeEngine.buildStatCache) return;
  // historyê°€ {numbers:[]} í˜•íƒœë©´ 2D ë°°ì—´ë¡œ ë³€í™˜
  var nums = history[0] && history[0].numbers
    ? history.map(function(d){ return d.numbers; })
    : history;
  var stat=CubeEngine.buildStatCache(nums,{items:45,recentWindow:30,history:nums});
  function sec(id,obj){
    var arr=[]; for(var i=1;i<=45;i++) arr.push({n:i,v:obj[i]||0});
    arr.sort(function(a,b){return b.v-a.v;});
    $(id).innerHTML=arr.slice(0,10).map(function(x){
      return '<div class="sg-c"><div class="sg-n">'+x.n+'</div><div class="sg-v">'+x.v+'</div></div>';
    }).join('');
  }
  sec('statFreq',stat.freq); sec('statRecent',stat.recentFreq);
  sec('statGap',stat.gap);   sec('statReHit',stat.reHit);
}

// â•â• ì¶”ì²œ ì¡°í•© â•â•
function ballCls(n){return n<=10?'b1':n<=20?'b2':n<=30?'b3':n<=40?'b4':'b5';}
function renderCombos(results,scores){
  if(!results||!results.length) return;
  var wrap=$('comboWrap'); wrap.innerHTML='';
  results.forEach(function(combo,i){
    var row=document.createElement('div'); row.className='combo-row';
    var rk=document.createElement('div'); rk.className='cr'; rk.textContent='#'+(i+1);
    row.appendChild(rk);
    combo.forEach(function(n){
      var b=document.createElement('div'); b.className='ball '+ballCls(n); b.textContent=n; row.appendChild(b);
    });
    var sc=document.createElement('div'); sc.className='cs';
    sc.textContent=scores&&scores[i]?scores[i].toFixed(2):''; row.appendChild(sc);
    wrap.appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ loadSharedEngineState
//    - ê²½ë¡œ: lotto_history / shared_engine_state
//    - probMap í‚¤: n1~n45
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSharedEngineState(){
  try {
    var snap = await DOC.get();
    if(!snap.exists){ tlog('ì €ì¥ ë°ì´í„° ì—†ìŒ â†’ ì²« í•™ìŠµ ì‹œì‘','tw'); return null; }
    var data = snap.data();
    tlog('í•™ìŠµ ë°ì´í„° ë¡œë“œ: iteration='+( data.iteration||0)+
         ' | ì¶œì²˜='+(data.source||'-')+
         ' | bestScore='+((data.bestScore||0).toFixed?data.bestScore.toFixed(2):'-'), 'ts');
    return data;
  } catch(e){ tlog('ë¡œë“œ ì‹¤íŒ¨: '+e.message,'te'); return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ restoreProbMap
//    - í‚¤ 'n1'~'n45' â†’ ìˆ«ì í‚¤ë¡œ ë³µì›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function restoreProbMap(probMapStr){
  if(!probMapStr) return null;
  var probMap={};
  Object.keys(probMapStr).forEach(function(k){
    var num=parseInt(k.replace('n',''));
    if(!isNaN(num)&&num>=1&&num<=45) probMap[num]=parseFloat(probMapStr[k]);
  });
  var keys=Object.keys(probMap).length;
  if(keys===0) return null;
  tlog('probMap ë³µì›: '+keys+'ê°œ ë²ˆí˜¸','ti');
  return probMap;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ saveSharedEngineState
//    - íŠ¸ëœì­ì…˜ ê°€ì¤‘ í‰ê·  ëˆ„ì  ë³‘í•©
//    - iteration ì´ ìŒ“ì¼ìˆ˜ë¡ ê¸°ì¡´ í•™ìŠµ ê°€ì¤‘ì¹˜ ìš°ì„¸
//    - í‚¤: n1~n45 (ì ‘ë‘ì‚¬ 'n')
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveSharedEngineState(result, source){
  try {
    var engineVer = (typeof CubeEngine!=='undefined') ? CubeEngine.version : 'unknown';
    var actualIteration = 0;

    // â”€â”€ ìƒˆ probMap ë¬¸ìì—´í™” (n ì ‘ë‘ì‚¬) â”€â”€
    var newProbMapStr = {};
    Object.keys(result.probMap).forEach(function(k){
      newProbMapStr['n'+k] = result.probMap[k];
    });

    // â”€â”€ íŠ¸ëœì­ì…˜: ë™ì‹œ ì ‘ì† ì¶©ëŒ ë°©ì§€ + ê°€ì¤‘ í‰ê·  ëˆ„ì  ë³‘í•© â”€â”€
    await db.runTransaction(function(tx){
      return tx.get(DOC).then(function(snap){
        var existing = snap.exists ? snap.data() : null;
        var baseIter = existing ? (existing.iteration||0) : 0;
        actualIteration = baseIter + 1;

        // iteration ì´ ìŒ“ì¼ìˆ˜ë¡ ê¸°ì¡´ ê°€ì¤‘ì¹˜ê°€ ë†’ì•„ì§
        // ì‹ ê·œ: weight=1, ê¸°ì¡´: weight=min(baseIter, 50)
        var mergedProbMap = {};
        if(existing && existing.probMap && baseIter > 0){
          var w_old   = Math.min(baseIter, 50);
          var w_new   = 1;
          var w_total = w_old + w_new;
          for(var n=1;n<=45;n++){
            var key    = 'n'+n;
            var oldVal = existing.probMap[key]!=null ? parseFloat(existing.probMap[key])
                       : (newProbMapStr[key]!=null ? parseFloat(newProbMapStr[key]) : 0);
            var newVal = newProbMapStr[key]!=null ? parseFloat(newProbMapStr[key]) : oldVal;
            mergedProbMap[key] = (oldVal*w_old + newVal*w_new) / w_total;
          }
          tlog('ë³‘í•©: iter '+baseIter+'â†’'+actualIteration+
               ' | ê¸°ì¡´ë¹„ì¤‘ '+(w_old/w_total*100).toFixed(0)+'%', 'tw');
        } else {
          mergedProbMap = newProbMapStr;
          tlog('ì²« í•™ìŠµ ì €ì¥ (ì‹ ê·œ probMap)', 'ts');
        }

        var poolToSave = result.fullPool.slice(0,100).map(function(c){return{items:c};});

        tx.set(DOC, {
          probMap      : mergedProbMap,
          pool         : poolToSave,
          iteration    : actualIteration,
          engineVersion: engineVer,
          savedAt      : firebase.firestore.FieldValue.serverTimestamp(),
          bestScore    : result.scores[0]||0,
          source       : source||'monitor'
        });
      });
    });

    return actualIteration;
  } catch(e){ tlog('ì €ì¥ ì‹¤íŒ¨: '+e.message,'te'); return false; }
}

// â•â• ë°±í…ŒìŠ¤íŒ… ì „ìš© ì €ì¥ (backtest_engine_state) â•â•
async function saveBacktestState(probMap, source) {
  try {
    var engineVer = (typeof CubeEngine!=='undefined') ? CubeEngine.version : 'unknown';
    var actualIteration = 0;
    var newProbMapStr = {};
    for(var n=1;n<=45;n++) newProbMapStr['n'+n] = probMap[n] || 0;

    await db.runTransaction(function(tx){
      return tx.get(BT_DOC).then(function(snap){
        var existing = snap.exists ? snap.data() : null;
        var baseIter = existing ? (existing.iteration||0) : 0;
        actualIteration = baseIter + 1;

        var mergedProbMap = {};
        if(existing && existing.probMap && baseIter > 0){
          var w_old = Math.min(baseIter, 30);
          var w_new = 1;
          var w_total = w_old + w_new;
          for(var n=1;n<=45;n++){
            var key = 'n'+n;
            var oldVal = existing.probMap[key]!=null ? parseFloat(existing.probMap[key]) : (newProbMapStr[key]||0);
            var newVal = newProbMapStr[key]!=null ? parseFloat(newProbMapStr[key]) : oldVal;
            mergedProbMap[key] = (oldVal*w_old + newVal*w_new) / w_total;
          }
        } else {
          mergedProbMap = newProbMapStr;
        }

        tx.set(BT_DOC, {
          probMap      : mergedProbMap,
          iteration    : actualIteration,
          engineVersion: engineVer,
          savedAt      : firebase.firestore.FieldValue.serverTimestamp(),
          source       : source || 'backtest'
        });
      });
    });
    return actualIteration;
  } catch(e){ tlog('ë°±í…ŒìŠ¤íŒ… ì €ì¥ ì‹¤íŒ¨: '+e.message,'te'); return false; }
}

// â•â• ë°±í…ŒìŠ¤íŒ… probMap â†’ shared_engine_state ë³‘í•© ì ìš© â•â•
async function applyBacktestToLive() {
  if(!confirm('í˜„ì¬ ë°±í…ŒìŠ¤íŒ… í•™ìŠµ ê²°ê³¼ë¥¼ ë¡œë˜ ì›¹(shared_engine_state)ì— ì ìš©í•©ë‹ˆê¹Œ?\n\nê¸°ì¡´ ë¡œë˜ ì›¹ í•™ìŠµê³¼ 50:50ìœ¼ë¡œ ë³‘í•©ë©ë‹ˆë‹¤.')) return;
  try {
    $('btnApplyBt').disabled = true;
    $('btnApplyBt').textContent = 'â³ ì ìš© ì¤‘...';

    // â˜… v2.5.2: ë°±í…ŒìŠ¤íŒ… ì§„í–‰ë„ì—ì„œ probMap ë¡œë“œ
    var progressSnap = await BT_PROGRESS_DOC.get();
    if(!progressSnap.exists || !progressSnap.data().currentProbMap){ 
      alert('ë°±í…ŒìŠ¤íŒ… ì§„í–‰ë„ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°±í…ŒìŠ¤íŒ…ì„ ì‹¤í–‰í•˜ì„¸ìš”.'); 
      $('btnApplyBt').disabled = false;
      $('btnApplyBt').textContent = 'âœ… ë¡œë˜ ì›¹ì— ì ìš©';
      return; 
    }
    
    // Firebase í˜•ì‹(n1, n2, ...)ìœ¼ë¡œ ì €ì¥ëœ probMap
    var btProbMapSerialized = progressSnap.data().currentProbMap;

    // shared_engine_stateì— ë³‘í•© ë° ì €ì¥
    await db.runTransaction(function(tx){
      return tx.get(DOC).then(function(snap){
        var existing = snap.exists ? snap.data() : null;
        var merged = {};
        for(var n=1;n<=45;n++){
          var key = 'n'+n;
          var liveVal = existing&&existing.probMap&&existing.probMap[key]!=null ? parseFloat(existing.probMap[key]) : 0.1;
          var btVal   = btProbMapSerialized[key]!=null ? parseFloat(btProbMapSerialized[key]) : 0.1;
          merged[key] = (liveVal + btVal) / 2;  // 50:50 ë³‘í•©
        }
        tx.set(DOC, Object.assign({}, existing||{}, {
          probMap : merged,
          iteration: ((existing&&existing.iteration)||0) + 1,
          savedAt : firebase.firestore.FieldValue.serverTimestamp(),
          source  : 'backtest_applied'
        }), {merge:true});
      });
    });

    tlog('âœ… ë°±í…ŒìŠ¤íŒ… í•™ìŠµ â†’ ë¡œë˜ ì›¹ ì ìš© ì™„ë£Œ (50:50 ë³‘í•©)','ts');
    $('btnApplyBt').textContent = 'âœ… ì ìš© ì™„ë£Œ!';
    setTimeout(function(){ $('btnApplyBt').textContent = 'âœ… ë¡œë˜ ì›¹ì— ì ìš©'; $('btnApplyBt').disabled=false; }, 3000);
  } catch(e){
    tlog('ì ìš© ì‹¤íŒ¨: '+e.message,'te');
    $('btnApplyBt').disabled = false;
    $('btnApplyBt').textContent = 'âœ… ë¡œë˜ ì›¹ì— ì ìš©';
  }
}

// â•â• ìƒíƒœ í‘œì‹œ ê³µí†µ í•¨ìˆ˜ â•â•
function applyLoadedState(data){
  if(!data) return;
  var probMap = restoreProbMap(data.probMap);
  S.prevMap  = probMap;
  S.iter     = data.iteration || 0;
  S.prevBest = data.bestScore || 0;
  S.source   = data.source || '-';
  $('kpiIter').textContent   = S.iter;
  $('iterCount').textContent  = S.iter;
  $('kpiPool').textContent    = data.pool ? data.pool.length : 0;
  $('kpiBest').textContent    = data.bestScore ? data.bestScore.toFixed(2) : '-';
  $('lastSource').textContent = S.source;
  if(probMap){ renderHM(probMap); renderBar(probMap); renderCL(null,probMap); }
}

// â•â• ë©”ì¸ ì‹¤í–‰ â•â•
async function runEngine(){
  if(S.running) return;
  
  // Firebase ì—°ê²° ì²´í¬
  try {
    await db.collection(SHARED_COL).limit(1).get();
  } catch(e) {
    alert('Databaseì— ì—°ê²°ì´ ì•ˆë¼ í…ŒìŠ¤íŠ¸ê°€ ë¶ˆê°€ëŠ¥ í•©ë‹ˆë‹¤');
    tlog('Firebase ì—°ê²° ì‹¤íŒ¨: '+e.message,'te');
    setChip('err');
    return;
  }
  
  S.running=true; S.curve=[];
  $('btnRun').disabled=true; setChip('run');
  
  // poolSize ìŠ¬ë¼ì´ë” ê°’ ì½ê¸° ë° ë¹„í™œì„±í™”
  var poolSize = parseInt($('poolSlider').value) || 2500;
  $('poolSlider').disabled = true;
  
  tlog('â•â•â•â•â•â•â• í•™ìŠµ ì‹¤í–‰ â•â•â•â•â•â•â•','ts');
  tlog('ê²½ë¡œ: '+SHARED_COL+'/'+SHARED_DOC,'ti');
  tlog('Pool Size: '+poolSize.toLocaleString(),'ti');

  try {
    // 1. ë¡œë˜ ì›¹ ë‹¹ì²¨ íˆìŠ¤í† ë¦¬ ë¨¼ì € ë¡œë“œ (í•™ìŠµì— ì‚¬ìš©)
    $('phaseText').textContent = 'ë‹¹ì²¨ ë°ì´í„° ë¡œë”© ì¤‘...';
    var _lh = await loadLottoHistory();
    var historyNums = Array.isArray(_lh) ? _lh : (_lh.nums || []);
    var bonusNums   = Array.isArray(_lh) ? [] : (_lh.bonus || []);
    var allDraws    = Array.isArray(_lh) ? [] : (_lh.draws || []);
    S.historyNums = historyNums;
    if(historyNums.length){
      tlog('í•™ìŠµ ë°ì´í„°: '+historyNums.length+'íšŒì°¨ | ë³´ë„ˆìŠ¤: '+bonusNums.length+'ê°œ â†’ ì—”ì§„ ì „ë‹¬','ts');
    } else {
      tlog('íˆìŠ¤í† ë¦¬ ì—†ìŒ â€” ìˆœìˆ˜ ì§„í™” ëª¨ë“œë¡œ ì‹¤í–‰','tw');
    }

    // 2. ê³µìœ  ì—”ì§„ ìƒíƒœ ë¡œë“œ
    $('phaseText').textContent = 'í•™ìŠµ ìƒíƒœ ë¡œë”© ì¤‘...';
    var prevData = await loadSharedEngineState();
    var prevIter = prevData ? (prevData.iteration||0) : 0;
    var prevPool = prevData && prevData.pool
      ? prevData.pool.map(function(p){return p.items!==undefined?p.items:p;})
      : null;
    var prevProbMap = prevData ? restoreProbMap(prevData.probMap) : null;

    applyLoadedState(prevData);

    // 3. í•™ìŠµ ì‹¤í–‰
    var cfg = CubeEngine.withPreset('lotto645',{
      history        : historyNums.length ? historyNums : null,
      bonusHistory   : bonusNums.length > 0 ? bonusNums : null,
      colorZoneWeight: 0.20,
      rounds         : 50,
      poolSize       : poolSize,
      externalProbMap: prevProbMap,
      initialPool    : prevPool,
      onProgress: function(pct,stats){
        $('mainBar').style.width=pct+'%';
        $('pctText').textContent=pct+'%';
        if(stats){
          if(stats.message) $('phaseText').textContent=stats.message;
          if(stats.round!==undefined){
            $('roundNow').textContent=stats.round;
            if(stats.elapsed) $('elapsed').textContent=(Math.floor(stats.elapsed/1000))+'s';
            if(stats.poolSize) $('poolNow').textContent=stats.poolSize;
            if(stats.bestScore&&stats.bestScore>0){
              $('kpiBest').textContent=stats.bestScore.toFixed(2);
              S.curve.push(stats.bestScore); renderCurve();
            }
            tickTL(stats.round);
          }
        }
      },
      onRound: function(round,best){
        tlog('Round '+round+' â€” best:'+best.toFixed(2));
      }
    });

    initTL(cfg.rounds||50);
    tlog('ì—”ì§„ ê°€ë™ â€” rounds:'+cfg.rounds+' | poolSize:'+poolSize+' | history:'+(historyNums.length||'ì—†ìŒ')+' | prevProbMap:'+(prevProbMap?'ìˆìŒ':'ì—†ìŒ'),'ti');

    var result = await CubeEngine.generate(cfg);

    // 4. ê²°ê³¼ ì²˜ë¦¬
    S.curMap = result.probMap;
    var nb=result.scores[0], diff=nb-S.prevBest;
    $('kpiBest').textContent=nb.toFixed(2);
    $('kpiBestDiff').innerHTML=diff>0?'<span class="up">â–² '+diff.toFixed(2)+' í–¥ìƒ</span>':
      diff<0?'<span class="dn">â–¼ '+Math.abs(diff).toFixed(2)+' ê°ì†Œ</span>':'<span class="eq">â†’ ìœ ì§€</span>';
    S.prevBest=nb;
    $('kpiPool').textContent=result.fullPool?result.fullPool.length:poolSize;
    $('kpiIter').textContent=prevIter+1; $('iterCount').textContent=prevIter+1;
    $('lastRun').textContent=new Date().toLocaleTimeString('ko-KR');
    $('lastSource').textContent='monitor';

    renderHM(result.probMap); renderBar(result.probMap);
    renderCL(prevProbMap, result.probMap);
    renderCombos(result.results, result.scores);
    if(historyNums.length) renderStat(historyNums.map(function(n,i){return {numbers:n};}));

    tlog('ì™„ë£Œ â€” best:'+nb.toFixed(2)+' elapsed:'+result.meta.elapsed+'ms','ts');

    // 5. ë¡œë˜ ì›¹ê³¼ ë™ì¼ ê²½ë¡œì— ì €ì¥
    tlog('Firebase ì €ì¥ ì¤‘ (lotto_history/shared_engine_state)...','ti');
    var savedIter = await saveSharedEngineState(result,'monitor');
    tlog('ì €ì¥ ì™„ë£Œ âœ… iteration:'+savedIter+' (ë¡œë˜ ì›¹ ê³µìœ )','ts');

    setChip('done'); $('phaseText').textContent='ì™„ë£Œ!';

  } catch(e){
    tlog('ì˜¤ë¥˜: '+e.message,'te'); setChip('err');
    console.error(e);
  } finally {
    S.running=false; 
    $('btnRun').disabled=false;
    $('poolSlider').disabled = false;
  }
}

// â•â• ë²„íŠ¼ â•â•
$('btnRun').onclick = runEngine;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°±í…ŒìŠ¤íŒ… ì—”ì§„
//  1~TRAIN_UNTIL íšŒì°¨ë¡œ ì´ˆê¸°í•™ìŠµ
//  TRAIN_UNTIL+1 ~ ë§ˆì§€ë§‰ íšŒì°¨: ì˜ˆì¸¡ â†’ ë¹„êµ â†’ probMap í”¼ë“œë°±
//  ìµœì¢… probMap â†’ shared_engine_state ì €ì¥ (ë¡œë˜ ì›¹ ë°˜ì˜)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var BT = {
  running: false,
  stats: { hit6:0, hit5:0, hit4:0, hit3:0, hit2:0, totalHits:0, count:0 }
};

var BT_REPEAT_COUNT = 0;

// â”€â”€ v2.5.0 ì²´í¬í¬ì¸íŠ¸ ìƒíƒœ â”€â”€
var BT_STATE = {
  allDraws        : [],    // ì „ì²´ ë‹¹ì²¨ ë°ì´í„°
  currentProbMap  : null,  // í˜„ì¬ í•™ìŠµëœ probMap
  cumulativeHistory: [],   // ëˆ„ì  ë‹¹ì²¨ ë²ˆí˜¸
  cumulativeBonus : [],    // ëˆ„ì  ë³´ë„ˆìŠ¤
  nextIdx         : 0,     // ë‹¤ìŒ ì‹¤í–‰í•  testDraws ì¸ë±ìŠ¤
  TRAIN_UNTIL     : 900,   // ì´ˆê¸° í•™ìŠµ ê²½ê³„
  totalProcessed  : 0,     // ì „ì²´ ì²˜ë¦¬ íšŒì°¨ ìˆ˜ (ë°˜ë³µ í¬í•¨)
  repeatRound     : 0      // ì „ì²´ ë°˜ë³µ íšŸìˆ˜
};

// â•â• ì²´í¬í¬ì¸íŠ¸ ì˜êµ¬ ì €ì¥ (window.storage) â•â•
var BT_STORAGE_KEY = 'bt_checkpoint_v2';

async function saveBtCheckpoint() {
  try {
    // allDrawsëŠ” Firebaseì—ì„œ ë‹¤ì‹œ ë¡œë“œ ê°€ëŠ¥í•˜ë¯€ë¡œ ì œì™¸ (ìš©ëŸ‰ ì ˆì•½)
    var toSave = {
      currentProbMap   : BT_STATE.currentProbMap,
      cumulativeHistory: BT_STATE.cumulativeHistory,
      cumulativeBonus  : BT_STATE.cumulativeBonus,
      nextIdx          : BT_STATE.nextIdx,
      TRAIN_UNTIL      : BT_STATE.TRAIN_UNTIL,
      totalProcessed   : BT_STATE.totalProcessed,
      repeatRound      : BT_STATE.repeatRound,
      btStats          : BT.stats,
      btAutoNext       : $('btAutoNext').checked,
      btRepeat         : $('btRepeat').checked,
      savedAt          : new Date().toISOString()
    };
    await window.storage.set(BT_STORAGE_KEY, JSON.stringify(toSave));
    tlog('ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ ì €ì¥ (nextIdx:'+BT_STATE.nextIdx+')','ti');
  } catch(e) {
    tlog('âš ï¸ ì²´í¬í¬ì¸íŠ¸ ì €ì¥ ì‹¤íŒ¨: '+e.message,'tw');
  }
}

async function loadBtCheckpoint() {
  try {
    var result = await window.storage.get(BT_STORAGE_KEY);
    if(!result || !result.value) return null;
    return JSON.parse(result.value);
  } catch(e) {
    return null;
  }
}

async function clearBtCheckpoint() {
  try {
    await window.storage.delete(BT_STORAGE_KEY);
    tlog('ğŸ—‘ ì²´í¬í¬ì¸íŠ¸ ì´ˆê¸°í™”ë¨','ti');
  } catch(e) {}
}

// â•â• Firebase ë°±í…ŒìŠ¤íŒ… ì§„í–‰ë„ ì €ì¥/ë¡œë“œ (v2.5.2) â•â•
async function saveBtProgressToFirebase() {
  try {
    var progressData = {
      currentProbMap   : BT_STATE.currentProbMap ? serializeProbMap(BT_STATE.currentProbMap) : null,
      cumulativeHistory: BT_STATE.cumulativeHistory,
      cumulativeBonus  : BT_STATE.cumulativeBonus,
      nextIdx          : BT_STATE.nextIdx,
      TRAIN_UNTIL      : BT_STATE.TRAIN_UNTIL,
      totalProcessed   : BT_STATE.totalProcessed,
      repeatRound      : BT_STATE.repeatRound,
      btStats          : BT.stats,
      btAutoNext       : $('btAutoNext').checked,
      btRepeat         : $('btRepeat').checked,
      savedAt          : firebase.firestore.FieldValue.serverTimestamp(),
      version          : '2.5.2'
    };

    await BT_PROGRESS_DOC.set(progressData);
    tlog('â˜ï¸ Firebase ì§„í–‰ë„ ì €ì¥ ì™„ë£Œ (nextIdx:'+BT_STATE.nextIdx+')','ti');
    return true;
  } catch(e) {
    tlog('âš ï¸ Firebase ì§„í–‰ë„ ì €ì¥ ì‹¤íŒ¨: '+e.message,'tw');
    return false;
  }
}

async function loadBtProgressFromFirebase() {
  try {
    var snap = await BT_PROGRESS_DOC.get();
    if(!snap.exists) {
      tlog('Firebase ì§„í–‰ë„ ì—†ìŒ','ti');
      return null;
    }
    var data = snap.data();
    
    // probMap ì—­ì§ë ¬í™”
    if(data.currentProbMap) {
      data.currentProbMap = deserializeProbMap(data.currentProbMap);
    }
    
    tlog('â˜ï¸ Firebase ì§„í–‰ë„ ë¡œë“œ: nextIdx='+data.nextIdx+' | ì²˜ë¦¬='+data.totalProcessed+'íšŒ','ts');
    return data;
  } catch(e) {
    tlog('âš ï¸ Firebase ì§„í–‰ë„ ë¡œë“œ ì‹¤íŒ¨: '+e.message,'tw');
    return null;
  }
}

async function clearBtProgressFromFirebase() {
  try {
    await BT_PROGRESS_DOC.delete();
    tlog('ğŸ—‘ Firebase ì§„í–‰ë„ ì‚­ì œë¨','ti');
  } catch(e) {
    tlog('âš ï¸ Firebase ì§„í–‰ë„ ì‚­ì œ ì‹¤íŒ¨: '+e.message,'tw');
  }
}

// probMap ì§ë ¬í™”/ì—­ì§ë ¬í™” í—¬í¼
function serializeProbMap(probMap) {
  var serialized = {};
  for(var n=1; n<=45; n++) {
    serialized['n'+n] = probMap[n] || 0;
  }
  return serialized;
}

function deserializeProbMap(serialized) {
  var probMap = {};
  for(var n=1; n<=45; n++) {
    probMap[n] = serialized['n'+n] || 0;
  }
  return probMap;
}

// â•â• í˜ì´ì§€ ë¡œë“œ ì‹œ ì²´í¬í¬ì¸íŠ¸ ë³µì› ì‹œë„ (Firebase ìš°ì„ ) â•â•
async function tryRestoreBtCheckpoint() {
  // â‘  Firebaseì—ì„œ ë¨¼ì € ì‹œë„
  var firebaseSaved = await loadBtProgressFromFirebase();
  var localSaved = await loadBtCheckpoint();
  
  var saved = null;
  var source = '';
  
  // Firebaseì™€ ë¡œì»¬ ëª¨ë‘ ìˆìœ¼ë©´ ë” ìµœì‹  ê²ƒ ì„ íƒ
  if(firebaseSaved && localSaved) {
    var fbTime = firebaseSaved.savedAt ? new Date(firebaseSaved.savedAt.toDate()).getTime() : 0;
    var localTime = localSaved.savedAt ? new Date(localSaved.savedAt).getTime() : 0;
    
    if(fbTime >= localTime) {
      saved = firebaseSaved;
      source = 'Firebase';
    } else {
      saved = localSaved;
      source = 'ë¡œì»¬ ìŠ¤í† ë¦¬ì§€';
    }
  } else if(firebaseSaved) {
    saved = firebaseSaved;
    source = 'Firebase';
  } else if(localSaved) {
    saved = localSaved;
    source = 'ë¡œì»¬ ìŠ¤í† ë¦¬ì§€';
  }
  
  if(!saved || saved.nextIdx === undefined) return;

  // ë³µì› ê°€ëŠ¥í•œ ìƒíƒœì¸ì§€ í™•ì¸ (nextIdx > 0 ì´ì–´ì•¼ ì˜ë¯¸ ìˆìŒ)
  if(saved.nextIdx <= 0 && saved.totalProcessed <= 0) return;

  var savedAt = saved.savedAt 
    ? (saved.savedAt.toDate ? saved.savedAt.toDate().toLocaleString('ko-KR') : new Date(saved.savedAt).toLocaleString('ko-KR'))
    : 'ì•Œ ìˆ˜ ì—†ìŒ';
  tlog('ğŸ“‚ ì €ì¥ëœ ì²´í¬í¬ì¸íŠ¸ ë°œê²¬! ('+source+') nextIdx:'+saved.nextIdx+' | ì²˜ë¦¬:'+saved.totalProcessed+'íšŒ | '+savedAt,'tw');

  // BT_STATEì— ë©”íƒ€ ì •ë³´ë§Œ ë¯¸ë¦¬ ë³µì› (allDrawsëŠ” ì‹¤í–‰ ì‹œ ë¡œë“œ)
  BT_STATE.currentProbMap    = saved.currentProbMap || null;
  BT_STATE.cumulativeHistory = saved.cumulativeHistory || [];
  BT_STATE.cumulativeBonus   = saved.cumulativeBonus || [];
  BT_STATE.nextIdx           = saved.nextIdx || 0;
  BT_STATE.TRAIN_UNTIL       = saved.TRAIN_UNTIL || 900;
  BT_STATE.totalProcessed    = saved.totalProcessed || 0;
  BT_STATE.repeatRound       = saved.repeatRound || 0;

  if(saved.btStats) BT.stats = saved.btStats;
  if(saved.btAutoNext !== undefined) $('btAutoNext').checked = saved.btAutoNext;
  if(saved.btRepeat !== undefined)   $('btRepeat').checked   = saved.btRepeat;

  BT_REPEAT_COUNT = BT_STATE.repeatRound;
  $('btRepeatCount').textContent = BT_REPEAT_COUNT;
  $('btTotalDraws').textContent  = BT_STATE.totalProcessed;

  // ë³µì› ì•ˆë‚´ ë°°ë„ˆ í‘œì‹œ
  $('btPanel').style.display = 'block';
  $('btStatus').textContent  = 'ğŸ“‚ ì´ì „ ì²´í¬í¬ì¸íŠ¸ ë³µì›ë¨ ('+source+') â€” '+savedAt+' | '+BT_STATE.nextIdx+'íšŒì°¨ê¹Œì§€ ì™„ë£Œ';
  $('btCheckpoint').textContent = BT_STATE.TRAIN_UNTIL + BT_STATE.nextIdx + 'íšŒì°¨ê¹Œì§€ ('+source+')';
  $('btnBtContinue').style.display = 'inline-block';
  $('btnBtRestart').style.display  = 'inline-block';
  btUpdateStats();

  tlog('âœ… ì²´í¬í¬ì¸íŠ¸ ë³µì› ì™„ë£Œ ('+source+') â€” [â–¶ ê³„ì†] ë²„íŠ¼ìœ¼ë¡œ ì´ì–´ì„œ ì§„í–‰í•˜ì„¸ìš”','ts');
}

function btShowBalls(predicted, actual) {
  function makeBall(n, hit) {
    var d = document.createElement('div');
    d.textContent = n;
    d.style.cssText = [
      'width:28px;height:28px;border-radius:50%;display:flex;align-items:center;',
      'justify-content:center;font-size:11px;font-weight:bold;',
      'background:' + (hit ? '#f5a623' : (n<=10?'#f7e60a':n<=20?'#69c8f0':n<=30?'#f56c6c':n<=40?'#444':'')),
      hit ? 'box-shadow:0 0 6px #f5a623;' : '',
      n>40&&!hit ? 'background:#5cb85c;' : '',
      'color:' + (n<=20&&!hit?'#000':'#fff') + ';'
    ].join('');
    return d;
  }
  var pb = $('btPredBalls'); pb.innerHTML = '';
  var ab = $('btActualBalls'); ab.innerHTML = '';
  predicted.forEach(function(n) {
    pb.appendChild(makeBall(n, actual.indexOf(n) >= 0));
  });
  actual.forEach(function(n) {
    var hit = predicted.indexOf(n) >= 0;
    ab.appendChild(makeBall(n, hit));
  });
}

function btLog(msg, color) {
  var el = $('btLog');
  var div = document.createElement('div');
  div.style.color = color || '#8b949e';
  div.textContent = msg;
  el.insertBefore(div, el.firstChild);
  if(el.children.length > 100) el.removeChild(el.lastChild);
}

function btUpdateStats() {
  var s = BT.stats;
  $('bt6').textContent = s.hit6;
  $('bt5').textContent = s.hit5;
  $('bt4').textContent = s.hit4;
  $('bt3').textContent = s.hit3;
  $('bt2').textContent = s.hit2;
  if(s.count > 0) {
    $('btHitRate').textContent = (s.totalHits / s.count).toFixed(2) + 'ê°œ';
    var best = s.hit6>0?6:s.hit5>0?5:s.hit4>0?4:s.hit3>0?3:2;
    $('btBestHit').textContent = best + 'ê°œ';
  }
}

// ì˜ˆì¸¡ ê²°ê³¼ì™€ ì‹¤ì œ ë‹¹ì²¨ ë¹„êµ í›„ probMap ë³´ì •
function btFeedback(probMap, predicted, actual, bonus) {
  var hitCount = 0;
  predicted.forEach(function(n){ if(actual.indexOf(n)>=0) hitCount++; });

  // ë§ì€ ë²ˆí˜¸ëŠ” í™•ë¥  ê°•í™”, í‹€ë¦° ë²ˆí˜¸ëŠ” ì•½í™”
  var reinforceRate = 0.08;  // ë§ìœ¼ë©´ +8%
  var penaltyRate   = 0.03;  // í‹€ë¦¬ë©´ -3%

  for(var n=1; n<=45; n++) {
    var inPredicted = predicted.indexOf(n) >= 0;
    var inActual    = actual.indexOf(n) >= 0;
    var isBonus     = (n === bonus);

    if(inPredicted && inActual) {
      // ì˜ˆì¸¡O ì‹¤ì œO â†’ ê°•í™”
      probMap[n] = Math.min((probMap[n]||0.1) * (1 + reinforceRate), 0.95);
    } else if(inPredicted && !inActual) {
      // ì˜ˆì¸¡O ì‹¤ì œX â†’ ì•½í™”
      probMap[n] = Math.max((probMap[n]||0.1) * (1 - penaltyRate), 0.01);
    } else if(!inPredicted && inActual) {
      // ì˜ˆì¸¡X ì‹¤ì œO â†’ ì•½ê°„ ê°•í™” (ë†“ì³¤ìœ¼ë‹ˆ ë‹¤ìŒì—” í¬í•¨)
      probMap[n] = Math.min((probMap[n]||0.1) * (1 + reinforceRate * 0.5), 0.95);
    }
    // ë³´ë„ˆìŠ¤ ë²ˆí˜¸ë„ ì•½ê°„ ê°•í™”
    if(isBonus) {
      probMap[n] = Math.min((probMap[n]||0.1) * 1.03, 0.95);
    }
  }
  // ì •ê·œí™”: í•©ê³„ë¥¼ 1ë¡œ
  var sum = 0;
  for(var m=1; m<=45; m++) sum += (probMap[m]||0);
  if(sum > 0) for(var m=1; m<=45; m++) probMap[m] = (probMap[m]||0) / sum * 0.5;

  return hitCount;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  v2.5.0 ë°±í…ŒìŠ¤íŒ… â€” 50íšŒ ë‹¨ìœ„ ì²´í¬í¬ì¸íŠ¸
//  - 900íšŒ ì´ˆê¸°í•™ìŠµ â†’ 50íšŒì”© ê²€ì¦ â†’ ë©ˆì¶¤/ê³„ì†
//  - ì´ì „ í•™ìŠµ probMap ëˆ„ì  ë°˜ì˜
//  - ë°ì´í„° ì†Œì§„ ì‹œ ìë™ ë°˜ë³µ (btRepeat ì²´í¬)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function btUpdateCheckpointUI() {
  var s = BT_STATE;
  var testLen = s.allDraws.length - s.TRAIN_UNTIL;
  var done = s.nextIdx;
  var remain = testLen - done;
  $('btCheckpoint').textContent = (s.TRAIN_UNTIL + done) + 'íšŒì°¨ / ì´ ' + s.allDraws.length + 'íšŒì°¨ (ë‚¨ì€ ' + remain + 'íšŒ)';
  $('btTotalDraws').textContent = s.totalProcessed;
}

// 50íšŒ ë‹¨ìœ„ ì‹¤í–‰ â€” resume: trueë©´ ì´ì–´ì„œ, falseë©´ ì²˜ìŒë¶€í„°
async function runBacktestChunk(resume) {
  if(BT.running) return;

  // ì²˜ìŒ ì‹œì‘ì´ë©´ ë°ì´í„° ë¡œë“œ (ë³µì› í›„ ì´ì–´ê°€ê¸° ì‹œë„í•  ë•Œë„ allDrawsê°€ ì—†ìœ¼ë©´ ë¡œë“œ)
  if(!resume || BT_STATE.allDraws.length === 0) {
    $('btStatus').textContent = 'ë‹¹ì²¨ ë°ì´í„° ë¡œë”© ì¤‘...';
    var _lh = await loadLottoHistory();
    BT_STATE.allDraws = Array.isArray(_lh) ? [] : (_lh.draws || []);

    if(BT_STATE.allDraws.length < 100) {
      $('btStatus').textContent = 'âŒ ë°ì´í„° ë¶€ì¡± (ìµœì†Œ 100íšŒì°¨ í•„ìš”)';
      return;
    }
    // â˜… ë³µì›ëœ ìƒíƒœì¸ë° allDrawsë§Œ ì—†ì—ˆë˜ ê²½ìš° TRAIN_UNTIL ìœ ì§€
    if(resume && BT_STATE.nextIdx > 0) {
      tlog('ğŸ“‚ allDraws ì¬ë¡œë“œ ì™„ë£Œ ('+BT_STATE.allDraws.length+'íšŒì°¨) â€” ì²´í¬í¬ì¸íŠ¸ ì´ì–´ì„œ ì§„í–‰','ti');
    } else {
      BT_STATE.TRAIN_UNTIL = Math.min(900, Math.floor(BT_STATE.allDraws.length * 0.75));
    }
  }

  var allDraws    = BT_STATE.allDraws;
  var TRAIN_UNTIL = BT_STATE.TRAIN_UNTIL;
  var testDraws   = allDraws.slice(TRAIN_UNTIL);

  // ë°ì´í„° ì†Œì§„ í™•ì¸
  if(BT_STATE.nextIdx >= testDraws.length) {
    BT_STATE.repeatRound++;
    BT_REPEAT_COUNT = BT_STATE.repeatRound;
    $('btRepeatCount').textContent = BT_REPEAT_COUNT;

    if($('btRepeat').checked) {
      // ìë™ ë°˜ë³µ: nextIdx ë¦¬ì…‹, ì´ì „ probMap ìœ ì§€í•˜ì—¬ ì¬ì‹œì‘
      BT_STATE.nextIdx = 0;
      BT_STATE.cumulativeHistory = allDraws.slice(0, TRAIN_UNTIL).map(function(d){return d.numbers;});
      BT_STATE.cumulativeBonus   = allDraws.slice(0, TRAIN_UNTIL).map(function(d){return d.bonus;}).filter(function(b){return b&&b>=1&&b<=45;});
      tlog('ğŸ” ë°ì´í„° ì†Œì§„ â€” ìë™ ë°˜ë³µ #'+BT_STATE.repeatRound+' (ì´ì „ probMap ë°˜ì˜)','ti');
      btLog('â”€â”€ ìë™ ë°˜ë³µ #'+BT_STATE.repeatRound+' ì‹œì‘ â”€â”€', '#a371f7');
      await new Promise(function(r){setTimeout(r,800);});
    } else {
      $('btStatus').textContent = 'âœ… ì „ì²´ ë°ì´í„° ì†Œì§„ â€” ë°˜ë³µ ì²´í¬ë°•ìŠ¤ë¡œ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
      $('btnBtContinue').style.display = 'none';
      $('btnBtRestart').style.display = 'inline-block';
      BT.running = false;
      $('btnBacktest').disabled = false;
      $('btnRun').disabled = false;
      return;
    }
  }

  BT.running = true;
  $('btPanel').style.display = 'block';
  $('btnBacktest').disabled = true;
  $('btnRun').disabled = true;
  $('btnBtContinue').style.display = 'none';
  $('btnBtRestart').style.display = 'none';

  // ì´ˆê¸° í•™ìŠµ (ì²˜ìŒ ì‹œì‘ì´ê±°ë‚˜ nextIdx=0ì¼ ë•Œ)
  if(!resume || BT_STATE.currentProbMap === null || BT_STATE.nextIdx === 0) {
    BT.stats = { hit6:0, hit5:0, hit4:0, hit3:0, hit2:0, totalHits:0, count:0 };
    $('btLog').innerHTML = '';

    tlog('ğŸ”¬ ë°±í…ŒìŠ¤íŒ… ì‹œì‘ â€” ì´ˆê¸°í•™ìŠµ: 1~'+TRAIN_UNTIL+'íšŒ | ê²€ì¦: '+testDraws.length+'íšŒ | 50íšŒ ë‹¨ìœ„ ì‹¤í–‰','ts');
    $('btStatus').textContent = 'â‘  ì´ˆê¸° í•™ìŠµ ì¤‘ (1~'+TRAIN_UNTIL+'íšŒì°¨)...';

    var trainDraws = allDraws.slice(0, TRAIN_UNTIL);
    var trainNums  = trainDraws.map(function(d){ return d.numbers; });
    var trainBonus = trainDraws.map(function(d){ return d.bonus; }).filter(function(b){ return b&&b>=1&&b<=45; });

    // ì´ì „ ë°±í…ŒìŠ¤íŒ… probMap ë¡œë“œ (ë°˜ë³µ í•™ìŠµ ì‹œ ëˆ„ì )
    var prevBtProbMap = null;
    if(BT_STATE.repeatRound > 0 || BT_REPEAT_COUNT > 0) {
      try {
        var prevSnap = await BT_DOC.get();
        if(prevSnap.exists && prevSnap.data().probMap) {
          prevBtProbMap = {};
          var raw = prevSnap.data().probMap;
          for(var n=1;n<=45;n++) prevBtProbMap[n] = raw['n'+n]!=null ? parseFloat(raw['n'+n]) : 0.1;
          tlog('ğŸ“‚ ì´ì „ ë°±í…ŒìŠ¤íŒ… probMap ë¡œë“œ (ë°˜ë³µ #'+BT_STATE.repeatRound+')','ti');
        }
      } catch(e) { tlog('ì´ì „ probMap ë¡œë“œ ì‹¤íŒ¨: '+e.message,'tw'); }
    }

    try {
      var initResult = await CubeEngine.generate(
        CubeEngine.withPreset('turbo', {
          history        : trainNums,
          bonusHistory   : trainBonus.length > 0 ? trainBonus : null,
          colorZoneWeight: 0.20,
          topN           : 5,
          rounds         : 30
        })
      );

      // ì´ì „ í•™ìŠµ ë°˜ì˜: ì´ì „ probMap 50% + ì´ˆê¸°í•™ìŠµ 50%
      var initProbMap = {};
      if(prevBtProbMap) {
        for(var n=1;n<=45;n++) initProbMap[n] = prevBtProbMap[n]*0.5 + (initResult.probMap[n]||0.1)*0.5;
        btLog('ì´ì „ í•™ìŠµ ë°˜ì˜ (50:50 ë¸”ë Œë”©)', '#69c8f0');
      } else {
        for(var n=1;n<=45;n++) initProbMap[n] = initResult.probMap[n] || 0.1;
      }
      BT_STATE.currentProbMap = initProbMap;
      BT_STATE.cumulativeHistory = trainNums.slice();
      BT_STATE.cumulativeBonus   = trainBonus.slice();
      BT_STATE.nextIdx = 0;

      S.curve = initResult.scoreHistory || [];
      renderCurve();
      tlog('âœ… ì´ˆê¸° í•™ìŠµ ì™„ë£Œ â€” best:'+initResult.scores[0].toFixed(2),'ts');
      btLog('ì´ˆê¸°í•™ìŠµ ì™„ë£Œ best:'+initResult.scores[0].toFixed(2), '#00ff88');
      initTL(testDraws.length);
    } catch(e) {
      tlog('ì´ˆê¸° í•™ìŠµ ì˜¤ë¥˜: '+e.message,'te');
      BT.running = false;
      $('btnBacktest').disabled = false;
      $('btnRun').disabled = false;
      return;
    }
  }

  // â”€â”€ ì „ì²´ ê²€ì¦ ë£¨í”„ (5íšŒë§ˆë‹¤ ìë™ ì €ì¥) â”€â”€
  var CHUNK_SIZE = testDraws.length;  // v2.5.2: ì „ì²´ í•œë²ˆì— ì‹¤í–‰
  var startIdx   = BT_STATE.nextIdx;
  var endIdx     = Math.min(startIdx + CHUNK_SIZE, testDraws.length);
  var currentProbMap = BT_STATE.currentProbMap;

  $('btStatus').textContent = 'â‘¡ ê²€ì¦ ì¤‘: ' + (TRAIN_UNTIL+startIdx+1) + '~' + (TRAIN_UNTIL+endIdx) + 'íšŒì°¨ (5íšŒë§ˆë‹¤ ìë™ ì €ì¥)';
  tlog('â–¶ '+( TRAIN_UNTIL+startIdx+1)+'~'+(TRAIN_UNTIL+endIdx)+'íšŒì°¨ ê²€ì¦ ì‹œì‘ (5íšŒë§ˆë‹¤ ìë™ ì €ì¥)','ti');

  try {
    for(var ti=startIdx; ti<endIdx; ti++) {
      var draw    = testDraws[ti];
      var actual  = draw.numbers;
      var bonus   = draw.bonus;
      var roundNo = draw.round || (TRAIN_UNTIL + ti + 1);

      var predResult = await CubeEngine.generate(
        CubeEngine.withPreset('turbo', {
          history        : BT_STATE.cumulativeHistory,
          bonusHistory   : BT_STATE.cumulativeBonus.length > 0 ? BT_STATE.cumulativeBonus : null,
          colorZoneWeight: 0.20,
          externalProbMap: currentProbMap,
          topN           : 1,
          rounds         : 10,
          poolSize       : 500
        })
      );

      var predicted = predResult.results[0] || [];
      var hitCount  = btFeedback(currentProbMap, predicted, actual, bonus);

      BT_STATE.cumulativeHistory.push(actual);
      if(bonus&&bonus>=1&&bonus<=45) BT_STATE.cumulativeBonus.push(bonus);

      BT_STATE.totalProcessed++;
      BT.stats.count++;
      BT.stats.totalHits += hitCount;
      if(hitCount>=6) BT.stats.hit6++;
      else if(hitCount>=5) BT.stats.hit5++;
      else if(hitCount>=4) BT.stats.hit4++;
      else if(hitCount>=3) BT.stats.hit3++;
      else BT.stats.hit2++;

      S.curve.push(hitCount*100 + (predResult.scores[0]||0));
      if((ti-startIdx)%5===0) renderCurve();
      tickTL(ti+1);
      if((ti-startIdx)%10===0) renderHM(currentProbMap);

      var pct = Math.round((ti+1)/testDraws.length*100);
      $('btBar').style.width = pct+'%';
      $('btProgress').textContent = pct+'%';
      $('btCurDraw').textContent = roundNo+'íšŒ';
      btUpdateStats();
      btShowBalls(predicted, actual);
      btUpdateCheckpointUI();

      var hitColor = hitCount>=4?'#f5a623':hitCount>=3?'#00ff88':'#8b949e';
      btLog(roundNo+'íšŒ ['+hitCount+'ê°œ] ì˜ˆì¸¡:'+predicted.join(',')+'  ì‹¤ì œ:'+actual.join(','), hitColor);

      // â˜… v2.5.2: ë§¤ íšŒì°¨ë§ˆë‹¤ nextIdx ì—…ë°ì´íŠ¸ ë° ì§„í–‰ë„ ì €ì¥
      BT_STATE.nextIdx = ti + 1;
      BT_STATE.currentProbMap = currentProbMap;
      
      // ë§¤ íšŒì°¨ë§ˆë‹¤ Firebase ì§„í–‰ë„ ì €ì¥ (ì¤‘ë‹¨ í›„ ì¬ê°œ ìœ„í•´)
      await saveBtProgressToFirebase();
      await saveBtCheckpoint();  // ë¡œì»¬ë„ í•¨ê»˜ ì €ì¥

      if((ti-startIdx)%5===0) {
        await new Promise(function(r){ setTimeout(r,0); });
      }
    }

    // ì²­í¬ ì™„ë£Œ
    BT_STATE.nextIdx = endIdx;
    BT_STATE.currentProbMap = currentProbMap;

    // â˜… ìµœì¢… ì§„í–‰ë„ ì €ì¥
    await saveBtProgressToFirebase();
    await saveBtCheckpoint();
    
    // â˜… "ë¡œë˜ ì›¹ì— ì ìš©" ë²„íŠ¼ í‘œì‹œ (ì‚¬ìš©ìê°€ ì›í•  ë•Œë§Œ ì ìš©)
    $('btnApplyBt').style.display = 'block';
    tlog('ğŸ’¾ ì§„í–‰ë„ ì €ì¥ ì™„ë£Œ â€” [âœ… ë¡œë˜ ì›¹ì— ì ìš©] ë²„íŠ¼ìœ¼ë¡œ í•™ìŠµ ê²°ê³¼ë¥¼ ë¡œë˜ ì›¹ì— ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤','ti');

    renderCurve();
    renderHM(currentProbMap);
    renderBar(currentProbMap);

    // ì „ì²´ ì™„ë£Œ (CHUNK_SIZE = testDraws.lengthì´ë¯€ë¡œ í•­ìƒ ì™„ë£Œ)
    BT_STATE.repeatRound++;
    BT_REPEAT_COUNT = BT_STATE.repeatRound;
    $('btRepeatCount').textContent = BT_REPEAT_COUNT;
    tlog('ğŸ ì „ì²´ ê²€ì¦ ì™„ë£Œ â€” ì´ '+BT_STATE.totalProcessed+'íšŒì°¨ ì²˜ë¦¬ | ë°˜ë³µ '+BT_STATE.repeatRound+'íšŒ','ts');

    if($('btRepeat').checked) {
      // ìë™ ë°˜ë³µ
      BT_STATE.nextIdx = 0;
      BT_STATE.cumulativeHistory = allDraws.slice(0,TRAIN_UNTIL).map(function(d){return d.numbers;});
      BT_STATE.cumulativeBonus   = allDraws.slice(0,TRAIN_UNTIL).map(function(d){return d.bonus;}).filter(function(b){return b&&b>=1&&b<=45;});
      BT.running = false;
      $('btnBacktest').disabled = false;
      $('btnRun').disabled = false;
      btLog('â”€â”€ ìë™ ë°˜ë³µ #'+BT_STATE.repeatRound+' ì‹œì‘ â”€â”€', '#a371f7');
      await new Promise(function(r){setTimeout(r,1000);});
      runBacktestChunk(true);
      return;
    }
    
    // ì™„ë£Œ - ì²´í¬í¬ì¸íŠ¸ ì‚­ì œ
    $('btStatus').textContent = 'âœ… ì „ì²´ ì™„ë£Œ! ì´ '+BT_STATE.totalProcessed+'íšŒì°¨ | ë°˜ë³µ '+BT_STATE.repeatRound+'íšŒ';
    $('btnBtContinue').style.display = 'none';
    $('btnBtRestart').style.display = 'inline-block';
    await clearBtCheckpoint();
    await clearBtProgressFromFirebase();

  } catch(e) {
    tlog('ê²€ì¦ ì˜¤ë¥˜: '+e.message,'te');
    $('btStatus').textContent = 'âŒ ì˜¤ë¥˜: '+e.message;
    console.error(e);
  } finally {
    BT.running = false;
    $('btnBacktest').disabled = false;
    $('btnRun').disabled = false;
  }
}

// ì²˜ìŒë¶€í„° ì‹œì‘
async function runBacktest() {
  BT_STATE.currentProbMap = null;
  BT_STATE.nextIdx = 0;
  BT_STATE.totalProcessed = 0;
  BT_STATE.allDraws = [];
  await clearBtCheckpoint();  // â˜… ë¡œì»¬ ì²´í¬í¬ì¸íŠ¸ ì´ˆê¸°í™”
  await clearBtProgressFromFirebase();  // â˜… Firebase ì§„í–‰ë„ë„ ì´ˆê¸°í™”
  runBacktestChunk(false);
}

$('btnBacktest').onclick = runBacktest;
$('btnBtContinue').onclick = function(){ runBacktestChunk(true); };
$('btnBtRestart').onclick = function(){
  if(confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆê¹Œ? í˜„ì¬ ì²´í¬í¬ì¸íŠ¸ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) runBacktest();
};
$('btnApplyBt').onclick = applyBacktestToLive;



// â•â• ì´ˆê¸° ìë™ ë¡œë“œ â•â•
(async function(){
  tlog('ì´ˆê¸° ìƒíƒœ í™•ì¸ ì¤‘...','ti');
  tlog('ê²½ë¡œ: '+SHARED_COL+'/'+SHARED_DOC,'ti');

  // history ê²½ë¡œ ì‚¬ì „ ì²´í¬ (ì‹¤ì œ ë¡œë“œëŠ” ì‹¤í–‰ ì‹œ)
  try {
    var hSnap = await db.collection('lotto_history').doc('lotto645_history').get();
    var hEl = $('historyStatus');
    if(hSnap.exists && hSnap.data().draws && hSnap.data().draws.length){
      var cnt = hSnap.data().draws.length;
      hEl.className='path-match';
      hEl.textContent='âœ… '+cnt+'íšŒì°¨ í™•ì¸ë¨ (ì‹¤í–‰ ì‹œ ë¡œë“œ)';
      tlog('ë‹¹ì²¨ ë°ì´í„° í™•ì¸: '+cnt+'íšŒì°¨ (lotto645_history)','ts');
    } else {
      hEl.className='path-mismatch';
      hEl.textContent='âš ï¸ ë°ì´í„° ì—†ìŒ';
      tlog('ë‹¹ì²¨ ë°ì´í„°: ì—†ìŒ (CSV ì—…ë¡œë“œ í•„ìš”)','tw');
    }
  } catch(e){
    $('historyStatus').className='path-mismatch';
    $('historyStatus').textContent='âŒ í™•ì¸ ì‹¤íŒ¨';
    tlog('ë‹¹ì²¨ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: '+e.message,'te');
  }

  var data = await loadSharedEngineState();
  if(data){
    applyLoadedState(data);
    setChip('done');
    tlog('ê¸°ì¡´ í•™ìŠµ ìƒíƒœ ë¡œë“œ ì™„ë£Œ (iter:'+S.iter+')','ts');
  } else {
    tlog('ì €ì¥ ë°ì´í„° ì—†ìŒ â€” í•™ìŠµ ì‹¤í–‰ ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”','tw');
  }
  if(typeof CubeEngine!=='undefined'&&CubeEngine.version)
    $('verBadge').textContent='v'+CubeEngine.version;

  // â˜… ë°±í…ŒìŠ¤íŒ… ì²´í¬í¬ì¸íŠ¸ ë³µì› ì‹œë„
  await tryRestoreBtCheckpoint();
})();
</script>
</body>
</html>
