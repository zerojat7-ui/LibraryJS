<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CubeEngine v2.1.0 â€” í•™ìŠµ ëª¨ë‹ˆí„°</title>
<style>
:root {
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --green:#00ff88; --blue:#58a6ff; --yellow:#f5a623;
  --red:#ff6b6b; --purple:#a371f7; --text:#e6edf3; --sub:#8b949e;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Segoe UI',monospace;background:var(--bg);color:var(--text);padding:12px;min-height:100vh}

.hd{display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 18px;margin-bottom:12px}
.hd-title{font-size:17px;font-weight:bold;color:var(--green)}
.hd-meta{font-size:11px;color:var(--sub);text-align:right;line-height:1.8}
.badge{display:inline-block;background:#21262d;border:1px solid var(--border);color:var(--blue);font-size:10px;padding:2px 7px;border-radius:20px;margin-left:6px}

.btn-row{display:flex;gap:8px;margin-bottom:12px}
.btn{flex:1;padding:11px;border:none;border-radius:8px;font-size:13px;font-weight:bold;cursor:pointer;transition:all .15s}
.btn:active{transform:scale(.97)}
.btn-run{background:#238636;color:#fff}.btn-run:hover{background:#2ea043}
.btn-load{background:#21262d;color:var(--text);border:1px solid var(--border)}.btn-load:hover{background:#30363d}
.btn-reset{background:#6e1414;color:#fff}.btn-reset:hover{background:#b91c1c}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px}
@media(max-width:680px){.g2,.g4{grid-template-columns:1fr 1fr}}

.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
.card-ttl{font-size:11px;font-weight:bold;color:var(--sub);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.dot{width:8px;height:8px;border-radius:50%}
.dg{background:var(--green);box-shadow:0 0 6px var(--green)}
.db{background:var(--blue);box-shadow:0 0 5px var(--blue)}
.dy{background:var(--yellow)}.dr{background:var(--red)}.dp{background:var(--purple)}

.kv{font-size:26px;font-weight:bold;color:var(--green);line-height:1.1}
.ks{font-size:11px;color:var(--sub);margin-top:3px}
.kd{font-size:12px;margin-top:4px}
.up{color:var(--green)}.dn{color:var(--red)}.eq{color:var(--sub)}

.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:bold}
.c-idle{background:#21262d;color:var(--sub);border:1px solid var(--border)}
.c-run{background:#1a3a2a;color:var(--green);border:1px solid #2ea043;animation:blink .9s infinite}
.c-done{background:#1a2a3a;color:var(--blue);border:1px solid var(--blue)}
.c-err{background:#3a1a1a;color:var(--red);border:1px solid var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}

.pb-wrap{background:#21262d;border-radius:4px;height:7px;overflow:hidden;margin:8px 0}
.pb-fill{height:100%;border-radius:4px;transition:width .25s;background:var(--green)}

.timeline{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px}
.tl{width:13px;height:13px;border-radius:3px;background:#21262d;border:1px solid var(--border);transition:background .15s}
.tl.done{background:var(--green);border-color:var(--green)}
.tl.active{background:var(--yellow);border-color:var(--yellow);animation:blink .6s infinite}

.heatmap{display:grid;grid-template-columns:repeat(9,1fr);gap:3px;margin-top:6px}
.hm{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;cursor:pointer;transition:transform .12s}
.hm:hover{transform:scale(1.25);z-index:10;position:relative}

.bar-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.bar-n{width:22px;text-align:right;color:var(--blue);font-weight:bold}
.bar-bg{flex:1;background:#21262d;border-radius:3px;height:13px;overflow:hidden}
.bar-f{height:100%;border-radius:3px;background:var(--purple);transition:width .35s}
.bar-p{width:40px;text-align:right;color:var(--sub)}

canvas{width:100%;border-radius:8px;display:block;background:#010409;border:1px solid var(--border)}

.cl{max-height:140px;overflow-y:auto;font-size:11px;margin-top:6px}
.cl-row{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #1c2128}
.cl-n{color:var(--blue);font-weight:bold;width:26px}
.cl-up{color:var(--green)}.cl-dn{color:var(--red)}

.term{background:#010409;border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-family:monospace;font-size:11px;color:var(--green);height:160px;overflow-y:auto;line-height:1.7;margin-top:6px}
.ti{color:var(--blue)}.tw{color:var(--yellow)}.ts{color:var(--green)}.te{color:var(--red)}

.combo-wrap{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.combo-row{display:flex;align-items:center;gap:4px}
.cr{font-size:10px;color:var(--sub);width:20px}
.ball{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold}
.b1{background:linear-gradient(135deg,#FFD700,#FFA500);color:#222}
.b2{background:linear-gradient(135deg,#4dabf7,#1971c2);color:#fff}
.b3{background:linear-gradient(135deg,#ff6b6b,#c92a2a);color:#fff}
.b4{background:linear-gradient(135deg,#495057,#212529);color:#fff}
.b5{background:linear-gradient(135deg,#51cf66,#2f9e44);color:#fff}
.cs{font-size:10px;color:var(--purple);margin-left:4px}

/* poolSize ìŠ¬ë¼ì´ë” */
.pool-ctrl{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.pool-label{font-size:12px;color:var(--sub);white-space:nowrap;flex-shrink:0}
.pool-slider{flex:1;min-width:160px;-webkit-appearance:none;height:5px;border-radius:3px;background:linear-gradient(to right,var(--green) 0%,var(--green) var(--pct,10%),#21262d var(--pct,10%));outline:none;cursor:pointer}
.pool-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--green);border:2px solid #0d1117;box-shadow:0 0 5px var(--green);cursor:pointer}
.pool-slider::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--green);border:2px solid #0d1117;cursor:pointer}
.pool-val{font-size:16px;font-weight:bold;color:var(--green);min-width:54px;text-align:right}
.pool-marks{display:flex;justify-content:space-between;font-size:9px;color:var(--sub);margin-top:2px;flex:1;min-width:160px;padding:0 8px}

/* í•™ìŠµ ê²½ë¡œ í‘œì‹œ */
.path-box{background:#0d1117;border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:11px;font-family:monospace;margin-bottom:10px}
.path-row{display:flex;align-items:center;gap:10px;padding:3px 0}
.path-label{color:var(--sub);width:100px;flex-shrink:0}
.path-val{color:var(--yellow);font-weight:bold}
.path-match{color:var(--green);font-size:10px;margin-left:6px}
.path-mismatch{color:var(--red);font-size:10px;margin-left:6px}

.sg{display:grid;grid-template-columns:repeat(5,1fr);gap:3px;margin-top:6px}
.sg-c{background:#21262d;border-radius:4px;padding:4px 2px;text-align:center;font-size:9px}
.sg-n{color:var(--blue);font-weight:bold}.sg-v{color:var(--green);margin-top:1px}
</style>
</head>
<body>

<!-- í—¤ë” -->
<div class="hd">
  <div>
    <span class="hd-title">ğŸ§Š CubeEngine í•™ìŠµ ëª¨ë‹ˆí„°</span>
    <span class="badge" id="verBadge">v2.1.0</span>
  </div>
  <div class="hd-meta">
    <div>ìƒíƒœ: <span id="chipWrap"><span class="chip c-idle">â¬œ ëŒ€ê¸° ì¤‘</span></span></div>
    <div>ëˆ„ì  í•™ìŠµ: <strong id="iterCount" style="color:var(--green)">0</strong>íšŒ &nbsp;|&nbsp; ì¶œì²˜: <span id="lastSource">-</span> &nbsp;|&nbsp; ë§ˆì§€ë§‰: <span id="lastRun">-</span></div>
  </div>
</div>

<!-- í•™ìŠµ ê²½ë¡œ ë™ê¸°í™” ìƒíƒœ -->
<div class="path-box">
  <div class="path-row">
    <span class="path-label">ğŸ“ ì»¬ë ‰ì…˜</span>
    <span class="path-val">lotto_history</span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ“„ ë¬¸ì„œ</span>
    <span class="path-val">shared_engine_state</span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ”‘ probMap í‚¤</span>
    <span class="path-val">n1, n2, ... n45</span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼ í¬ë§·</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ”€ ë³‘í•© ë°©ì‹</span>
    <span class="path-val">íŠ¸ëœì­ì…˜ ê°€ì¤‘í‰ê·  ëˆ„ì </span>
    <span class="path-match">âœ… ë¡œë˜ ì›¹ê³¼ ë™ì¼ ë¡œì§</span>
  </div>
  <div class="path-row">
    <span class="path-label">ğŸ—‚ ë‹¹ì²¨ íˆìŠ¤í† ë¦¬</span>
    <span class="path-val">lotto_history / lotto645_history â†’ draws</span>
    <span id="historyStatus" class="path-match">â³ ë¡œë”© ëŒ€ê¸°</span>
  </div>
</div>

<!-- poolSize ìŠ¬ë¼ì´ë” -->
<div class="pool-ctrl">
  <span class="pool-label">ğŸ› Pool Size</span>
  <div style="flex:1;min-width:160px">
    <input type="range" class="pool-slider" id="poolSlider"
      min="100" max="10000" step="100" value="2500"
      oninput="updatePoolSlider(this.value)">
    <div class="pool-marks">
      <span>100</span><span>2,500</span><span>5,000</span><span>7,500</span><span>10,000</span>
    </div>
  </div>
  <span class="pool-val" id="poolValDisp">2,500</span>
</div>

<!-- ë²„íŠ¼ -->
<div class="btn-row">
  <button class="btn btn-run"   id="btnRun">â–¶ í•™ìŠµ ì‹¤í–‰ (ë¡œë˜ ì›¹ê³¼ ê³µìœ )</button>
  <button class="btn btn-load"  id="btnLoad">ğŸ“¥ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button class="btn btn-reset" id="btnReset">ğŸ—‘ ì´ˆê¸°í™”</button>
</div>

<!-- KPI -->
<div class="g4">
  <div class="card"><div class="card-ttl"><div class="dot dg"></div>ëˆ„ì  Iteration</div><div class="kv" id="kpiIter">0</div><div class="ks">ì´ í•™ìŠµ íšŸìˆ˜</div></div>
  <div class="card"><div class="card-ttl"><div class="dot db"></div>Pool í¬ê¸°</div><div class="kv" id="kpiPool" style="color:var(--blue)">0</div><div class="ks">ìƒì¡´ ì¡°í•© ìˆ˜</div></div>
  <div class="card"><div class="card-ttl"><div class="dot dy"></div>Best Score</div><div class="kv" id="kpiBest" style="color:var(--yellow)">-</div><div class="kd" id="kpiBestDiff"></div></div>
  <div class="card"><div class="card-ttl"><div class="dot dp"></div>ë³€í™” ë²ˆí˜¸</div><div class="kv" id="kpiChanged" style="color:var(--purple)">0</div><div class="ks">í™•ë¥  ë³€ë™ ìˆ˜</div></div>
</div>

<!-- ì§„í–‰ + íƒ€ì„ë¼ì¸ -->
<div class="g2">
  <div class="card">
    <div class="card-ttl"><div class="dot dg"></div>ì§„í–‰ ìƒí™©</div>
    <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
      <span id="phaseText" style="color:var(--yellow)">ëŒ€ê¸° ì¤‘</span>
      <span id="pctText"   style="color:var(--green);font-weight:bold">0%</span>
    </div>
    <div class="pb-wrap"><div class="pb-fill" id="mainBar" style="width:0%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--sub);margin-top:4px">
      <span>ê²½ê³¼: <span id="elapsed">0s</span></span>
      <span>ë¼ìš´ë“œ: <span id="roundNow">0</span>/<span id="roundTotal">50</span></span>
      <span>pool: <span id="poolNow">0</span></span>
    </div>
  </div>
  <div class="card">
    <div class="card-ttl"><div class="dot db"></div>ë¼ìš´ë“œ íƒ€ì„ë¼ì¸</div>
    <div class="timeline" id="timeline"></div>
  </div>
</div>

<!-- íˆíŠ¸ë§µ + ë°” ì°¨íŠ¸ -->
<div class="g2">
  <div class="card">
    <div class="card-ttl"><div class="dot dp"></div>í™•ë¥ ë§µ íˆíŠ¸ë§µ (1~45)</div>
    <div class="heatmap" id="heatmap"></div>
  </div>
  <div class="card">
    <div class="card-ttl"><div class="dot dy"></div>ìƒìœ„ 10ë²ˆí˜¸ í™•ë¥ </div>
    <div id="barChart" style="margin-top:6px"></div>
  </div>
</div>

<!-- í•™ìŠµ ê³¡ì„  + ë³€í™” ë¡œê·¸ -->
<div class="g2">
  <div class="card">
    <div class="card-ttl"><div class="dot dg"></div>í•™ìŠµ ê³¡ì„  (Best Score)</div>
    <canvas id="curveCanvas" height="110"></canvas>
  </div>
  <div class="card">
    <div class="card-ttl"><div class="dot db"></div>í™•ë¥  ë³€í™” ë¡œê·¸ (ì´ì „ ëŒ€ë¹„)</div>
    <div class="cl" id="changeLog"><span style="color:var(--sub)">ëŒ€ê¸° ì¤‘...</span></div>
  </div>
</div>

<!-- StatCache ë¶„ì„ -->
<div class="card" style="margin-bottom:10px">
  <div class="card-ttl"><div class="dot dy"></div>StatCache â€” ë¹ˆë„ / ìµœê·¼30íšŒ / ê°„ê²© / ì¬ì¶œí˜„ (Top 10)</div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:6px">
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ğŸ”¥ Top ë¹ˆë„</div><div class="sg" id="statFreq"></div></div>
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">âš¡ ìµœê·¼30íšŒ</div><div class="sg" id="statRecent"></div></div>
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">â± ê°„ê²©(ë¯¸ì¶œí˜„)</div><div class="sg" id="statGap"></div></div>
    <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ğŸ”„ ì¬ì¶œí˜„ë¥ </div><div class="sg" id="statReHit"></div></div>
  </div>
</div>

<!-- ì¶”ì²œ ê²°ê³¼ + ì‹¤ì‹œê°„ ë¡œê·¸ -->
<div class="g2">
  <div class="card">
    <div class="card-ttl"><div class="dot dg"></div>ì¶”ì²œ ì¡°í•© Top 5</div>
    <div class="combo-wrap" id="comboWrap"><span style="color:var(--sub);font-size:12px">í•™ìŠµ ì™„ë£Œ í›„ í‘œì‹œë©ë‹ˆë‹¤</span></div>
  </div>
  <div class="card">
    <div class="card-ttl"><div class="dot db"></div>ì‹¤ì‹œê°„ ë¡œê·¸</div>
    <div class="term" id="terminal"><span class="ti">[ì‹œìŠ¤í…œ] CubeEngine v2.1.0 ì¤€ë¹„ ì™„ë£Œ</span></div>
  </div>
</div>

<script src="cube-engine.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase ì´ˆê¸°í™”
//  â˜… ë¡œë˜ ì›¹ê³¼ ì™„ì „íˆ ë™ì¼í•œ ì»¬ë ‰ì…˜/ë¬¸ì„œ ì‚¬ìš©
//    ì»¬ë ‰ì…˜: lotto_history
//    ë¬¸ì„œ  : shared_engine_state
//    í‚¤    : n1~n45 (ì ‘ë‘ì‚¬ 'n')
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
  apiKey:"AIzaSyB4S8qkK07QYXq5yw0Coo69sZBIk0uew2E",
  authDomain:"randextraccube-engine.firebaseapp.com",
  projectId:"randextraccube-engine",
  storageBucket:"randextraccube-engine.firebasestorage.app",
  messagingSenderId:"515597545439",
  appId:"1:515597545439:web:f1e804554406719a3cde6a"
});
var db = firebase.firestore();

// â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ ê²½ë¡œ
var SHARED_COL = 'lotto_history';
var SHARED_DOC = 'shared_engine_state';
var DOC = db.collection(SHARED_COL).doc(SHARED_DOC);

// â•â• ìƒíƒœ â•â•
var S = { iter:0, prevMap:null, curMap:null, curve:[], prevBest:0, running:false, source:'-', historyNums:[] };
var $ = function(id){ return document.getElementById(id); };

// â•â• í„°ë¯¸ë„ â•â•
function tlog(msg, cls) {
  var t=$('terminal');
  var d=document.createElement('div'); d.className=cls||'';
  d.textContent='['+new Date().toLocaleTimeString('ko-KR')+'] '+msg;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

// â•â• poolSize ìŠ¬ë¼ì´ë” â•â•
function updatePoolSlider(val){
  val = Math.round(val / 100) * 100;
  var pct = ((val - 100) / (10000 - 100) * 100).toFixed(1) + '%';
  var slider = $('poolSlider');
  slider.style.setProperty('--pct', pct);
  $('poolValDisp').textContent = Number(val).toLocaleString();
}
// ì´ˆê¸° ìŠ¬ë¼ì´ë” ìƒíƒœ ì„¤ì •
(function(){ updatePoolSlider(2500); })();

// â•â• ë¡œë˜ ì›¹ ë‹¹ì²¨ history ë¡œë“œ â•â•
//    ê²½ë¡œ: lotto_history / lotto645_history â†’ draws[].numbers
async function loadLottoHistory(){
  var statusEl = $('historyStatus');
  statusEl.className = 'path-match';
  statusEl.textContent = 'ğŸ”„ ë¡œë”© ì¤‘...';
  try {
    var snap = await db.collection('lotto_history').doc('lotto645_history').get();
    if(!snap.exists){
      statusEl.className = 'path-mismatch';
      statusEl.textContent = 'âš ï¸ ë¬¸ì„œ ì—†ìŒ';
      tlog('ë‹¹ì²¨ íˆìŠ¤í† ë¦¬: ë¬¸ì„œ ì—†ìŒ (lotto645_history)','tw');
      return [];
    }
    var data = snap.data();
    if(!data.draws || !data.draws.length){
      statusEl.className = 'path-mismatch';
      statusEl.textContent = 'âš ï¸ draws ë¹„ì–´ìˆìŒ';
      tlog('ë‹¹ì²¨ íˆìŠ¤í† ë¦¬: draws í•„ë“œ ì—†ìŒ ë˜ëŠ” ë¹ˆê°’','tw');
      return [];
    }
    var nums = data.draws.map(function(d){ return d.numbers; }).filter(function(n){ return n&&n.length===6; });
    statusEl.className = 'path-match';
    statusEl.textContent = 'âœ… '+nums.length+'íšŒì°¨ ë¡œë“œ ì™„ë£Œ';
    tlog('âœ… ë‹¹ì²¨ íˆìŠ¤í† ë¦¬ ë¡œë“œ: '+nums.length+'íšŒì°¨ (ë¡œë˜ ì›¹ ê³µìœ  ê²½ë¡œ)','ts');
    return nums;
  } catch(e){
    statusEl.className = 'path-mismatch';
    statusEl.textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨';
    tlog('ë‹¹ì²¨ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨: '+e.message,'te');
    return [];
  }
}

// â•â• ìƒíƒœ ì¹© â•â•
function setChip(type){
  var m={idle:'<span class="chip c-idle">â¬œ ëŒ€ê¸° ì¤‘</span>',
         run :'<span class="chip c-run">ğŸŸ¢ ì‹¤í–‰ ì¤‘</span>',
         done:'<span class="chip c-done">ğŸ”µ ì™„ë£Œ</span>',
         err :'<span class="chip c-err">ğŸ”´ ì˜¤ë¥˜</span>'};
  $('chipWrap').innerHTML=m[type]||m.idle;
}

// â•â• íƒ€ì„ë¼ì¸ â•â•
function initTL(n){
  var tl=$('timeline'); tl.innerHTML=''; $('roundTotal').textContent=n;
  for(var i=0;i<n;i++){var d=document.createElement('div');d.className='tl';d.id='tl'+i;tl.appendChild(d);}
}
function tickTL(r){
  var p=document.getElementById('tl'+(r-1)); if(p) p.className='tl done';
  var c=document.getElementById('tl'+r);    if(c) c.className='tl active';
}

// â•â• íˆíŠ¸ë§µ â•â•
function renderHM(probMap){
  if(!probMap) return;
  var hm=$('heatmap'); hm.innerHTML='';
  var vals=[]; for(var i=1;i<=45;i++) vals.push(probMap[i]||0);
  var mx=Math.max.apply(null,vals)||1, mn=Math.min.apply(null,vals);
  for(var i=1;i<=45;i++){
    var v=probMap[i]||0, t=(v-mn)/(mx-mn||1);
    var r=Math.round(t*80), g=Math.round(100+t*155), b=Math.round(50+t*50);
    var c=document.createElement('div'); c.className='hm';
    c.style.background='rgb('+r+','+g+','+b+')';
    c.style.color=t>0.55?'#000':'#fff';
    c.title='No.'+i+': '+(v*100).toFixed(2)+'%';
    c.textContent=i; hm.appendChild(c);
  }
}

// â•â• ë°” ì°¨íŠ¸ â•â•
function renderBar(probMap){
  if(!probMap) return;
  var arr=[]; for(var i=1;i<=45;i++) arr.push({n:i,v:probMap[i]||0});
  arr.sort(function(a,b){return b.v-a.v;}); var top=arr.slice(0,10);
  var mx=top[0].v||1, html='';
  top.forEach(function(x){
    var pct=(x.v/mx*100).toFixed(0);
    html+='<div class="bar-row"><div class="bar-n">'+x.n+'</div>'+
      '<div class="bar-bg"><div class="bar-f" style="width:'+pct+'%"></div></div>'+
      '<div class="bar-p">'+(x.v*100).toFixed(2)+'%</div></div>';
  });
  $('barChart').innerHTML=html;
}

// â•â• ë³€í™” ë¡œê·¸ â•â•
function renderCL(oldMap, newMap){
  if(!newMap) return;
  var html='', changed=0;
  for(var i=1;i<=45;i++){
    var o=oldMap?(oldMap[i]||0):0, n=newMap[i]||0, d=n-o;
    if(Math.abs(d)<0.0001) continue; changed++;
    var up=d>0;
    html+='<div class="cl-row"><span class="cl-n">'+i+'</span>'+
      '<span style="color:var(--sub)">'+o.toFixed(4)+' â†’ </span>'+
      '<span class="'+(up?'cl-up':'cl-dn')+'">'+n.toFixed(4)+' '+(up?'â–²':'â–¼')+Math.abs(d).toFixed(4)+'</span></div>';
  }
  $('changeLog').innerHTML=html||'<span style="color:var(--sub)">ë³€í™” ì—†ìŒ</span>';
  $('kpiChanged').textContent=changed;
}

// â•â• í•™ìŠµ ê³¡ì„  â•â•
function renderCurve(){
  var cv=$('curveCanvas'), W=cv.offsetWidth||380, H=110;
  cv.width=W; cv.height=H;
  var ctx=cv.getContext('2d'); ctx.clearRect(0,0,W,H);
  var data=S.curve;
  if(data.length<2){ctx.fillStyle='#8b949e';ctx.font='11px monospace';ctx.fillText('ë°ì´í„° ë¶€ì¡±',10,H/2);return;}
  var mx=Math.max.apply(null,data), mn=Math.min.apply(null,data)*0.98;
  ctx.strokeStyle='#21262d'; ctx.lineWidth=1;
  for(var i=0;i<=4;i++){var y=H-(i/4)*H;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  ctx.beginPath(); ctx.strokeStyle='#00ff88'; ctx.lineWidth=2;
  data.forEach(function(v,i){
    var x=i/(data.length-1)*W, y=H-((v-mn)/(mx-mn||1))*(H-6)-3;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  var lv=data[data.length-1], lx=W, ly=H-((lv-mn)/(mx-mn||1))*(H-6)-3;
  ctx.beginPath(); ctx.arc(lx-1,ly,4,0,Math.PI*2); ctx.fillStyle='#00ff88'; ctx.fill();
  ctx.fillStyle='#8b949e'; ctx.font='9px monospace'; ctx.textAlign='left';
  ctx.fillText(mx.toFixed(1),2,10); ctx.fillText(mn.toFixed(1),2,H-4);
}

// â•â• StatCache ë Œë” â•â•
function renderStat(history){
  if(!history||!history.length||!CubeEngine._buildStatCache) return;
  // historyê°€ {numbers:[]} í˜•íƒœë©´ 2D ë°°ì—´ë¡œ ë³€í™˜
  var nums = history[0] && history[0].numbers
    ? history.map(function(d){ return d.numbers; })
    : history;
  var stat=CubeEngine._buildStatCache(nums,{items:45,history:nums});
  function sec(id,obj){
    var arr=[]; for(var i=1;i<=45;i++) arr.push({n:i,v:obj[i]||0});
    arr.sort(function(a,b){return b.v-a.v;});
    $(id).innerHTML=arr.slice(0,10).map(function(x){
      return '<div class="sg-c"><div class="sg-n">'+x.n+'</div><div class="sg-v">'+x.v+'</div></div>';
    }).join('');
  }
  sec('statFreq',stat.freq); sec('statRecent',stat.recentFreq);
  sec('statGap',stat.gap);   sec('statReHit',stat.reHit);
}

// â•â• ì¶”ì²œ ì¡°í•© â•â•
function ballCls(n){return n<=10?'b1':n<=20?'b2':n<=30?'b3':n<=40?'b4':'b5';}
function renderCombos(results,scores){
  if(!results||!results.length) return;
  var wrap=$('comboWrap'); wrap.innerHTML='';
  results.forEach(function(combo,i){
    var row=document.createElement('div'); row.className='combo-row';
    var rk=document.createElement('div'); rk.className='cr'; rk.textContent='#'+(i+1);
    row.appendChild(rk);
    combo.forEach(function(n){
      var b=document.createElement('div'); b.className='ball '+ballCls(n); b.textContent=n; row.appendChild(b);
    });
    var sc=document.createElement('div'); sc.className='cs';
    sc.textContent=scores&&scores[i]?scores[i].toFixed(2):''; row.appendChild(sc);
    wrap.appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ loadSharedEngineState
//    - ê²½ë¡œ: lotto_history / shared_engine_state
//    - probMap í‚¤: n1~n45
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSharedEngineState(){
  try {
    var snap = await DOC.get();
    if(!snap.exists){ tlog('ì €ì¥ ë°ì´í„° ì—†ìŒ â†’ ì²« í•™ìŠµ ì‹œì‘','tw'); return null; }
    var data = snap.data();
    tlog('í•™ìŠµ ë°ì´í„° ë¡œë“œ: iteration='+( data.iteration||0)+
         ' | ì¶œì²˜='+(data.source||'-')+
         ' | bestScore='+((data.bestScore||0).toFixed?data.bestScore.toFixed(2):'-'), 'ts');
    return data;
  } catch(e){ tlog('ë¡œë“œ ì‹¤íŒ¨: '+e.message,'te'); return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ restoreProbMap
//    - í‚¤ 'n1'~'n45' â†’ ìˆ«ì í‚¤ë¡œ ë³µì›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function restoreProbMap(probMapStr){
  if(!probMapStr) return null;
  var probMap={};
  Object.keys(probMapStr).forEach(function(k){
    var num=parseInt(k.replace('n',''));
    if(!isNaN(num)&&num>=1&&num<=45) probMap[num]=parseFloat(probMapStr[k]);
  });
  var keys=Object.keys(probMap).length;
  if(keys===0) return null;
  tlog('probMap ë³µì›: '+keys+'ê°œ ë²ˆí˜¸','ti');
  return probMap;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… ë¡œë˜ ì›¹ê³¼ ë™ì¼í•œ saveSharedEngineState
//    - íŠ¸ëœì­ì…˜ ê°€ì¤‘ í‰ê·  ëˆ„ì  ë³‘í•©
//    - iteration ì´ ìŒ“ì¼ìˆ˜ë¡ ê¸°ì¡´ í•™ìŠµ ê°€ì¤‘ì¹˜ ìš°ì„¸
//    - í‚¤: n1~n45 (ì ‘ë‘ì‚¬ 'n')
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveSharedEngineState(result, source){
  try {
    var engineVer = (typeof CubeEngine!=='undefined') ? CubeEngine.version : 'unknown';
    var actualIteration = 0;

    // â”€â”€ ìƒˆ probMap ë¬¸ìì—´í™” (n ì ‘ë‘ì‚¬) â”€â”€
    var newProbMapStr = {};
    Object.keys(result.probMap).forEach(function(k){
      newProbMapStr['n'+k] = result.probMap[k];
    });

    // â”€â”€ íŠ¸ëœì­ì…˜: ë™ì‹œ ì ‘ì† ì¶©ëŒ ë°©ì§€ + ê°€ì¤‘ í‰ê·  ëˆ„ì  ë³‘í•© â”€â”€
    await db.runTransaction(function(tx){
      return tx.get(DOC).then(function(snap){
        var existing = snap.exists ? snap.data() : null;
        var baseIter = existing ? (existing.iteration||0) : 0;
        actualIteration = baseIter + 1;

        // iteration ì´ ìŒ“ì¼ìˆ˜ë¡ ê¸°ì¡´ ê°€ì¤‘ì¹˜ê°€ ë†’ì•„ì§
        // ì‹ ê·œ: weight=1, ê¸°ì¡´: weight=min(baseIter, 50)
        var mergedProbMap = {};
        if(existing && existing.probMap && baseIter > 0){
          var w_old   = Math.min(baseIter, 50);
          var w_new   = 1;
          var w_total = w_old + w_new;
          for(var n=1;n<=45;n++){
            var key    = 'n'+n;
            var oldVal = existing.probMap[key]!=null ? parseFloat(existing.probMap[key])
                       : (newProbMapStr[key]!=null ? parseFloat(newProbMapStr[key]) : 0);
            var newVal = newProbMapStr[key]!=null ? parseFloat(newProbMapStr[key]) : oldVal;
            mergedProbMap[key] = (oldVal*w_old + newVal*w_new) / w_total;
          }
          tlog('ë³‘í•©: iter '+baseIter+'â†’'+actualIteration+
               ' | ê¸°ì¡´ë¹„ì¤‘ '+(w_old/w_total*100).toFixed(0)+'%', 'tw');
        } else {
          mergedProbMap = newProbMapStr;
          tlog('ì²« í•™ìŠµ ì €ì¥ (ì‹ ê·œ probMap)', 'ts');
        }

        var poolToSave = result.fullPool.slice(0,100).map(function(c){return{items:c};});

        tx.set(DOC, {
          probMap      : mergedProbMap,
          pool         : poolToSave,
          iteration    : actualIteration,
          engineVersion: engineVer,
          savedAt      : firebase.firestore.FieldValue.serverTimestamp(),
          bestScore    : result.scores[0]||0,
          source       : source||'monitor'
        });
      });
    });

    return actualIteration;
  } catch(e){ tlog('ì €ì¥ ì‹¤íŒ¨: '+e.message,'te'); return false; }
}

// â•â• ìƒíƒœ í‘œì‹œ ê³µí†µ í•¨ìˆ˜ â•â•
function applyLoadedState(data){
  if(!data) return;
  var probMap = restoreProbMap(data.probMap);
  S.prevMap  = probMap;
  S.iter     = data.iteration || 0;
  S.prevBest = data.bestScore || 0;
  S.source   = data.source || '-';
  $('kpiIter').textContent   = S.iter;
  $('iterCount').textContent  = S.iter;
  $('kpiPool').textContent    = data.pool ? data.pool.length : 0;
  $('kpiBest').textContent    = data.bestScore ? data.bestScore.toFixed(2) : '-';
  $('lastSource').textContent = S.source;
  if(probMap){ renderHM(probMap); renderBar(probMap); renderCL(null,probMap); }
}

// â•â• ë©”ì¸ ì‹¤í–‰ â•â•
async function runEngine(){
  if(S.running) return;
  S.running=true; S.curve=[];
  $('btnRun').disabled=true; setChip('run');
  tlog('â•â•â•â•â•â•â• í•™ìŠµ ì‹¤í–‰ â•â•â•â•â•â•â•','ts');
  tlog('ê²½ë¡œ: '+SHARED_COL+'/'+SHARED_DOC,'ti');

  // poolSize ìŠ¬ë¼ì´ë” ê°’ ì½ê¸°
  var poolSize = parseInt($('poolSlider').value) || 2500;
  tlog('Pool Size: '+poolSize.toLocaleString(),'ti');

  try {
    // 1. ë¡œë˜ ì›¹ ë‹¹ì²¨ íˆìŠ¤í† ë¦¬ ë¨¼ì € ë¡œë“œ (í•™ìŠµì— ì‚¬ìš©)
    $('phaseText').textContent = 'ë‹¹ì²¨ ë°ì´í„° ë¡œë”© ì¤‘...';
    var historyNums = await loadLottoHistory();
    S.historyNums = historyNums;
    if(historyNums.length){
      tlog('í•™ìŠµ ë°ì´í„°: '+historyNums.length+'íšŒì°¨ â†’ ì—”ì§„ ì „ë‹¬','ts');
    } else {
      tlog('íˆìŠ¤í† ë¦¬ ì—†ìŒ â€” ìˆœìˆ˜ ì§„í™” ëª¨ë“œë¡œ ì‹¤í–‰','tw');
    }

    // 2. ê³µìœ  ì—”ì§„ ìƒíƒœ ë¡œë“œ
    $('phaseText').textContent = 'í•™ìŠµ ìƒíƒœ ë¡œë”© ì¤‘...';
    var prevData = await loadSharedEngineState();
    var prevIter = prevData ? (prevData.iteration||0) : 0;
    var prevPool = prevData && prevData.pool
      ? prevData.pool.map(function(p){return p.items!==undefined?p.items:p;})
      : null;
    var prevProbMap = prevData ? restoreProbMap(prevData.probMap) : null;

    applyLoadedState(prevData);

    // 3. í•™ìŠµ ì‹¤í–‰
    var cfg = CubeEngine.withPreset('lotto645',{
      history        : historyNums.length ? historyNums : null,
      rounds         : 50,
      poolSize       : poolSize,
      externalProbMap: prevProbMap,
      initialPool    : prevPool,
      onProgress: function(pct,stats){
        $('mainBar').style.width=pct+'%';
        $('pctText').textContent=pct+'%';
        if(stats){
          if(stats.message) $('phaseText').textContent=stats.message;
          if(stats.round!==undefined){
            $('roundNow').textContent=stats.round;
            if(stats.elapsed) $('elapsed').textContent=(Math.floor(stats.elapsed/1000))+'s';
            if(stats.poolSize) $('poolNow').textContent=stats.poolSize;
            if(stats.bestScore&&stats.bestScore>0){
              $('kpiBest').textContent=stats.bestScore.toFixed(2);
              S.curve.push(stats.bestScore); renderCurve();
            }
            tickTL(stats.round);
          }
        }
      },
      onRound: function(round,best){
        tlog('Round '+round+' â€” best:'+best.toFixed(2));
      }
    });

    initTL(cfg.rounds||50);
    tlog('ì—”ì§„ ê°€ë™ â€” rounds:'+cfg.rounds+' | poolSize:'+poolSize+' | history:'+(historyNums.length||'ì—†ìŒ')+' | prevProbMap:'+(prevProbMap?'ìˆìŒ':'ì—†ìŒ'),'ti');

    var result = await CubeEngine.generate(cfg);

    // 4. ê²°ê³¼ ì²˜ë¦¬
    S.curMap = result.probMap;
    var nb=result.scores[0], diff=nb-S.prevBest;
    $('kpiBest').textContent=nb.toFixed(2);
    $('kpiBestDiff').innerHTML=diff>0?'<span class="up">â–² '+diff.toFixed(2)+' í–¥ìƒ</span>':
      diff<0?'<span class="dn">â–¼ '+Math.abs(diff).toFixed(2)+' ê°ì†Œ</span>':'<span class="eq">â†’ ìœ ì§€</span>';
    S.prevBest=nb;
    $('kpiPool').textContent=result.fullPool?result.fullPool.length:poolSize;
    $('kpiIter').textContent=prevIter+1; $('iterCount').textContent=prevIter+1;
    $('lastRun').textContent=new Date().toLocaleTimeString('ko-KR');
    $('lastSource').textContent='monitor';

    renderHM(result.probMap); renderBar(result.probMap);
    renderCL(prevProbMap, result.probMap);
    renderCombos(result.results, result.scores);
    if(historyNums.length) renderStat(historyNums.map(function(n,i){return {numbers:n};}));

    tlog('ì™„ë£Œ â€” best:'+nb.toFixed(2)+' elapsed:'+result.meta.elapsed+'ms','ts');

    // 5. ë¡œë˜ ì›¹ê³¼ ë™ì¼ ê²½ë¡œì— ì €ì¥
    tlog('Firebase ì €ì¥ ì¤‘ (lotto_history/shared_engine_state)...','ti');
    var savedIter = await saveSharedEngineState(result,'monitor');
    tlog('ì €ì¥ ì™„ë£Œ âœ… iteration:'+savedIter+' (ë¡œë˜ ì›¹ ê³µìœ )','ts');

    setChip('done'); $('phaseText').textContent='ì™„ë£Œ!';

  } catch(e){
    tlog('ì˜¤ë¥˜: '+e.message,'te'); setChip('err');
    console.error(e);
  } finally {
    S.running=false; $('btnRun').disabled=false;
  }
}

// â•â• ë²„íŠ¼ â•â•
$('btnRun').onclick = runEngine;

$('btnLoad').onclick = async function(){
  tlog('ìƒíƒœ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...','ti');
  var data = await loadSharedEngineState();
  if(!data){ tlog('ë°ì´í„° ì—†ìŒ','tw'); return; }
  applyLoadedState(data);
  setChip('done');
  tlog('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (iter:'+S.iter+', source:'+S.source+')','ts');
};

$('btnReset').onclick = async function(){
  if(!confirm('Firebase í•™ìŠµ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆê¹Œ?\nâš ï¸ ë¡œë˜ ì›¹ì˜ í•™ìŠµ ë°ì´í„°ë„ ì‚¬ë¼ì§‘ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  try{
    await DOC.delete();
    S={iter:0,prevMap:null,curMap:null,curve:[],prevBest:0,running:false,source:'-'};
    ['kpiIter','kpiPool','kpiChanged'].forEach(function(id){$(id).textContent=0;});
    $('kpiBest').textContent='-'; $('kpiBestDiff').innerHTML='';
    $('iterCount').textContent=0; $('lastRun').textContent='-'; $('lastSource').textContent='-';
    $('heatmap').innerHTML=''; $('barChart').innerHTML='';
    $('changeLog').innerHTML='<span style="color:var(--sub)">ëŒ€ê¸° ì¤‘...</span>';
    $('comboWrap').innerHTML='<span style="color:var(--sub);font-size:12px">í•™ìŠµ ì™„ë£Œ í›„ í‘œì‹œë©ë‹ˆë‹¤</span>';
    $('mainBar').style.width='0%'; $('pctText').textContent='0%';
    $('phaseText').textContent='ëŒ€ê¸° ì¤‘'; $('roundNow').textContent='0';
    ['statFreq','statRecent','statGap','statReHit'].forEach(function(id){$(id).innerHTML='';});
    renderCurve(); setChip('idle');
    tlog('ì´ˆê¸°í™” ì™„ë£Œ (lotto_history/shared_engine_state ì‚­ì œ)','tw');
  }catch(e){tlog('ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message,'te');}
};

// â•â• ì´ˆê¸° ìë™ ë¡œë“œ â•â•
(async function(){
  tlog('ì´ˆê¸° ìƒíƒœ í™•ì¸ ì¤‘...','ti');
  tlog('ê²½ë¡œ: '+SHARED_COL+'/'+SHARED_DOC,'ti');

  // history ê²½ë¡œ ì‚¬ì „ ì²´í¬ (ì‹¤ì œ ë¡œë“œëŠ” ì‹¤í–‰ ì‹œ)
  try {
    var hSnap = await db.collection('lotto_history').doc('lotto645_history').get();
    var hEl = $('historyStatus');
    if(hSnap.exists && hSnap.data().draws && hSnap.data().draws.length){
      var cnt = hSnap.data().draws.length;
      hEl.className='path-match';
      hEl.textContent='âœ… '+cnt+'íšŒì°¨ í™•ì¸ë¨ (ì‹¤í–‰ ì‹œ ë¡œë“œ)';
      tlog('ë‹¹ì²¨ ë°ì´í„° í™•ì¸: '+cnt+'íšŒì°¨ (lotto645_history)','ts');
    } else {
      hEl.className='path-mismatch';
      hEl.textContent='âš ï¸ ë°ì´í„° ì—†ìŒ';
      tlog('ë‹¹ì²¨ ë°ì´í„°: ì—†ìŒ (CSV ì—…ë¡œë“œ í•„ìš”)','tw');
    }
  } catch(e){
    $('historyStatus').className='path-mismatch';
    $('historyStatus').textContent='âŒ í™•ì¸ ì‹¤íŒ¨';
    tlog('ë‹¹ì²¨ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: '+e.message,'te');
  }

  var data = await loadSharedEngineState();
  if(data){
    applyLoadedState(data);
    setChip('done');
    tlog('ê¸°ì¡´ í•™ìŠµ ìƒíƒœ ë¡œë“œ ì™„ë£Œ (iter:'+S.iter+')','ts');
  } else {
    tlog('ì €ì¥ ë°ì´í„° ì—†ìŒ â€” í•™ìŠµ ì‹¤í–‰ ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”','tw');
  }
  if(typeof CubeEngine!=='undefined'&&CubeEngine.version)
    $('verBadge').textContent='v'+CubeEngine.version;
})();
</script>
</body>
</html>
