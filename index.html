<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CubeEngine v1.3.0 Dashboard</title>
    <style>
        :root { --primary: #03dac6; --bg: #121212; --card: #1e1e1e; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .full { grid-column: 1 / -1; }
        h2 { color: var(--primary); margin-top: 0; font-size: 1.2rem; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        /* 상태 바 */
        .progress-container { background: #333; height: 8px; border-radius: 4px; margin: 15px 0; overflow: hidden; }
        #progressFill { width: 0%; height: 100%; background: var(--primary); transition: width 0.2s; }
        
        /* 데이터 출력 스타일 */
        pre { background: #000; padding: 12px; border-radius: 8px; font-size: 11px; color: #00ff41; height: 150px; overflow-y: auto; border: 1px solid #222; }
        .log-box { height: 100px; font-family: monospace; font-size: 12px; }
        
        /* 버튼 */
        button { width: 100%; background: #6200ee; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        button:disabled { background: #444; opacity: 0.6; }
        
        /* 통계 수치 */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .stat-val { font-weight: bold; color: var(--primary); }
        .diff-plus { color: #ff4d4d; } /* 확률 상승 */
        .diff-minus { color: #4d79ff; } /* 확률 하락 */
    </style>
</head>
<body>

<div class="grid">
    <div class="card full">
        <h2>CubeEngine 제어 센터</h2>
        <div class="stat-row">
            <span>엔진 상태: <span id="statusText">초기화 중...</span></span>
            <span>Iteration: <span id="iterCount" class="stat-val">0</span></span>
        </div>
        <div class="progress-container"><div id="progressFill"></div></div>
        <button id="runBtn" disabled>학습 및 진화 시작 (데이터 로드 포함)</button>
    </div>

    <div class="card">
        <h2>1. 데이터 로드 (Firebase)</h2>
        <div class="stat-row"><span>불러온 Pool 수:</span> <span id="loadPoolSize" class="stat-val">0</span></div>
        <div class="stat-row"><span>최근 저장 시간:</span> <span id="loadTime" class="stat-val">-</span></div>
        <pre id="loadRaw">대기 중...</pre>
    </div>

    <div class="card">
        <h2>2. 학습 변화 분석 (ProbMap)</h2>
        <div class="stat-row"><span>변화된 번호 수:</span> <span id="changedCount" class="stat-val">0</span></div>
        <div id="changeLog" class="log-box" style="overflow-y:auto; background:#000; padding:10px; border-radius:8px;">
            학습 전후 확률 변화가 여기에 표시됩니다.
        </div>
    </div>

    <div class="card full">
        <h2>3. 최종 결과 및 저장 검증</h2>
        <div class="stat-row">
            <span>추천 조합: <span id="bestCombo" class="stat-val">대기 중</span></span>
            <span>저장 완료 여부: <span id="saveStatus" class="stat-val">-</span></span>
        </div>
        <pre id="finalOutput">엔진 가동 시 최종 JSON 결과가 표시됩니다.</pre>
    </div>
</div>

<script src="https://zerojat7-ui.github.io/LibraryJS/cube-engine.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB4S8qkK07QYXq5yw0Coo69sZBIk0uew2E",
        authDomain: "randextraccube-engine.firebaseapp.com",
        projectId: "randextraccube-engine",
        storageBucket: "randextraccube-engine.firebasestorage.app",
        messagingSenderId: "515597545439",
        appId: "1:515597545439:web:f1e804554406719a3cde6a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const DOC_REF = doc(db, "CubeEngine", "main_engine_data");

    const el = (id) => document.getElementById(id);

    // [핵심] 학습 변화 계산 함수
    function analyzeLearning(oldMap, newMap) {
        let html = "";
        let changed = 0;
        for (let i = 1; i <= 45; i++) {
            const oldP = oldMap ? oldMap[i] || 0 : 0;
            const newP = newMap[i] || 0;
            const diff = newP - oldP;
            if (Math.abs(diff) > 0.001) {
                const icon = diff > 0 ? "▲" : "▼";
                const cls = diff > 0 ? "diff-plus" : "diff-minus";
                html += `<div style="font-size:11px;">No.${i}: ${oldP.toFixed(3)} → <b>${newP.toFixed(3)}</b> <span class="${cls}">${icon} ${Math.abs(diff).toFixed(4)}</span></div>`;
                changed++;
            }
        }
        el('changeLog').innerHTML = html || "변화 없음";
        el('changedCount').innerText = changed;
    }

    window.onload = () => {
        el('statusText').innerText = "연결 완료. 엔진 준비됨.";
        el('runBtn').disabled = false;
    };

    el('runBtn').onclick = async () => {
        const btn = el('runBtn');
        btn.disabled = true;
        el('statusText').innerText = "1단계: Firebase 데이터 로딩 중...";

        try {
            // 1. Firebase에서 이전 지식 로드
            const snap = await getDoc(DOC_REF);
            const prevData = snap.exists() ? snap.data() : null;

            if (prevData) {
                el('loadPoolSize').innerText = prevData.pool?.length || 0;
                el('loadTime').innerText = prevData.generatedAt?.toDate().toLocaleString() || "-";
                el('iterCount').innerText = prevData.iteration || 0;
                el('loadRaw').innerText = JSON.stringify(prevData.probMap, null, 2);
            }

            // 2. 엔진 가동 (이전 데이터 주입)
            el('statusText').innerText = "2단계: 하이브리드 진화 중...";
            const result = await CubeEngine.generate({
                ...CubeEngine.presets.lotto645,
                rounds: 30, // 빠른 테스트를 위해 30라운드
                externalProbMap: prevData?.probMap || null,
                initialPool: prevData?.pool || null,
                onProgress: (pct, stats) => {
                    el('progressFill').style.width = pct + "%";
                    el('statusText').innerText = `진화 중... (Round: ${stats.round}, Best: ${stats.bestScore?.toFixed(2)})`;
                }
            });

            // 3. 학습 결과 비교분석
            analyzeLearning(prevData?.probMap, result.probMap);

            // 4. Firebase 저장
            el('statusText').innerText = "3단계: 학습 결과 클라우드 저장 중...";
            const saveData = {
                probMap: result.probMap,
                pool: result.fullPool.slice(0, 100), // 상위 100개만 저장 (최적화)
                iteration: (prevData?.iteration || 0) + 1,
                generatedAt: serverTimestamp(),
                bestScore: result.scores[0]
            };
            await setDoc(DOC_REF, saveData);

            // 5. 최종 출력
            el('saveStatus').innerText = "성공 (Firestore)";
            el('bestCombo').innerText = result.results[0].join(", ");
            el('finalOutput').innerText = JSON.stringify(result, null, 2);
            el('statusText').innerText = "모든 작업 완료!";
            el('iterCount').innerText = saveData.iteration;

        } catch (err) {
            console.error(err);
            el('statusText').innerText = "오류 발생: " + err.message;
        } finally {
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
